<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="KouriChat - 配置中心">
    <meta name="keywords" content="AI,KouriChat">
    <meta name="theme-color" content="#6366f1">
    <title>KouriChat - 配置中心</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdmirror.com/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/static/mom.ico">
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #4f46e5;
            --background-color: #f0f4f8;
            /* 更柔和的浅蓝灰色背景 */
            --text-color: #1e293b;
            --card-bg: rgba(255, 255, 255, 0.494);
            --card-border: rgba(255, 255, 255, 0.5);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        [data-bs-theme="dark"] {
            --background-color: #1a1f2e;
            /* 更柔和的深色背景 */
            --text-color: #f8fafc;
            --card-bg: rgba(30, 41, 59, 0.612);
            --card-border: rgba(255, 255, 255, 0.1);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }

        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            background: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
        }

        .config-section {
            background: var(--card-bg);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            border-radius: 1rem;
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            animation: slideUp 0.5s ease forwards;
            animation-delay: 0.1s;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 添加卡片微妙的装饰效果 */
        .config-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            opacity: 0.5;
        }

        .form-control,
        .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--card-border) !important;
            background: var(--card-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.25);
            outline: none;
        }

        .form-switch .form-check-input {
            width: 3em;
            height: 1.5em;
            margin-left: -3.5em;
        }

        .form-label {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .badge-info {
            background: var(--primary-color);
            cursor: pointer;
        }

        .theme-switcher {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
        }

        .accordion-button {
            background: transparent;
            border: none;
        }

        .accordion-button:not(.collapsed) {
            background: rgba(var(--bs-primary-rgb), 0.1);
            color: var(--primary-color);
        }

        .accordion-item {
            background: transparent;
            border-color: var(--card-border);
        }

        .toast {
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-check-label {
            margin-top: 0;
        }

        /* 人设选择下拉栏样式 */
        select[name="AVATAR_DIR"] {
            max-height: 300px;
            overflow-y: auto;
        }


        .navbar .form-check.form-switch {
            display: flex;
            align-items: center;
            height: 100%;
            margin: 0;
        }


        .navbar .form-check-label {
            display: flex;
            align-items: center;
            margin: 0 0 0 8px;
            line-height: 1;
        }


        .navbar .form-check-input {
            margin: 0;
            vertical-align: middle;
        }

        /* 输入框组样式 */
        .input-group {
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .input-group .form-control {
            border: none !important;
        }

        /* 配置项容器样式 */
        .config-item {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* 响应式布局 */
        @media (max-width: 700px) {
            .config-section {
                padding: 1rem;
            }
        }

        /* 密码输入框样式 */
        .password-input-group {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
        }

        .password-toggle:hover {
            opacity: 1;
        }

        /* 修改左右两栏的间距 */
        @media (min-width: 768px) {
            .col-md-6.pe-md-2 {
                padding-right: 1.5rem !important;
                /* 增加右边距 */
            }

            .col-md-6.ps-md-2 {
                padding-left: 1.5rem !important;
                /* 增加左边距 */
            }
        }

        /* 修改响应式布局下的间距 */
        @media (max-width: 767px) {
            .col-md-6 {
                margin-bottom: 2rem;
                /* 增加上下间距 */
            }

            .config-section {
                margin-bottom: 0;
                /* 移除原有的底部间距 */
            }

            /* 为了让背景更好地显示，增加内容区域的内边距 */
            main.container-fluid {
                padding: 2rem 1rem;
                /* 调整移动端的内边距 */
            }

            /* 为底部保存按钮留出空间 */
            main.container-fluid {
                padding-bottom: 5rem;
                /* 底部留出更多空间 */
            }
        }

        /* 优化桌面端布局 */
        @media (min-width: 768px) {
            .col-md-6.pe-md-2 {
                padding-right: 1.5rem !important;
            }

            .col-md-6.ps-md-2 {
                padding-left: 1.5rem !important;
            }

            main.container-fluid {
                padding: 2rem;
                padding-bottom: 5rem;
                /* 为底部保存按钮留出空间 */
            }
        }

        /* 修改主容器的内边距 */
        main.container-fluid {
            padding: 2rem;
            /* 增加整体内边距 */
        }

        /* 添加相同的基础样式 */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            flex: 1 0 auto;
            width: 100%;
            padding: 2rem 0;
        }

        /* 添加通知动画 */
        .toast {
            transition: all 0.3s ease;
            transform: translateY(-20px);
            opacity: 0;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* 优化按钮悬停效果 */
        .btn-outline-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* 添加输入框过渡效果 */
        #customApiInput {
            transition: all 0.3s ease;
        }

        #customApiInput.show {
            transform: translateY(0);
            opacity: 1;
        }

        #customApiInput.hide {
            transform: translateY(-10px);
            opacity: 0;
        }

        /* 添加通知容器样式 */
        .notification-container {
            z-index: 1050;
        }

        .accordion-button {
            background: transparent !important;
        }

        .accordion-button:not(.collapsed) {
            color: rgb(147, 151, 255) !important;
        }

        .list-group-item {
            border: none;
            margin-bottom: 8px;
            border-radius: 8px !important;
            transition: all 0.3s ease;
        }

        /* 只针对定时任务的列表项应用深色样式 */
        #schedule-settings .list-group-item {
            background: rgba(30, 41, 59, 0.5);
            color: #fff;
        }

        #schedule-settings .list-group-item:hover {
            background: rgba(30, 41, 59, 0.8) !important;
            transform: translateX(5px);
        }

        /* 监听用户列表使用默认颜色 */
        #selected_users_LISTEN_LIST .list-group-item {
            background: var(--bs-list-group-bg);
            color: var(--bs-body-color);
        }

        /* 深色模式下的特定样式 */
        [data-bs-theme="dark"] #selected_users_LISTEN_LIST .list-group-item {
            background: rgba(30, 41, 59, 0.5);
            color: #fff;
        }

        .calendar-container {
            width: 100%;
            transition: all 0.3s ease;
        }

        .calendar-header {
            display: flex;
            margin-bottom: 8px;
        }

        .calendar-cell {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            font-weight: 500;
        }

        .calendar-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            animation: fadeIn 0.3s ease;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid transparent;
            background-color: transparent;
            position: relative;
            overflow: hidden;
        }

        .calendar-day:hover {
            transform: scale(1.1);
            background-color: rgba(var(--bs-primary-rgb), 0.1);
            z-index: 1;
        }

        .calendar-day.selected {
            animation: pulse 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background-color: var(--primary-color);
            color: white;
            transform: scale(1.05);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            border-color: var(--primary-color);
            font-weight: bold;
        }

        /* 选中动画 */
        @keyframes pulse {
            0% {
                transform: scale(0.8);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }

            100% {
                transform: scale(1.05);
            }
        }

        /* 波纹效果 */
        .calendar-day::after {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, var(--primary-color) 10%, transparent 10%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform 0.5s, opacity 0.8s;
            border-radius: 50%;
        }

        .calendar-day:active::after {
            transform: scale(0, 0);
            opacity: 0.3;
            transition: 0s;
        }

        /* 月份切换按钮动画 */
        #prevMonth,
        #nextMonth {
            transition: all 0.2s ease;
        }

        #prevMonth:hover,
        #nextMonth:hover {
            transform: scale(1.1);
            background-color: var(--primary-color);
            color: white;
        }

        /* 当前月份标题动画 */
        #currentMonth {
            transition: all 0.3s ease;
        }

        /* 按钮组动画 */
        .btn-group-sm .btn {
            transition: all 0.2s ease;
        }

        .btn-group-sm .btn:hover {
            transform: translateY(-2px);
        }

        /* 确认按钮动画 */
        .modal-footer .btn-primary {
            transition: all 0.2s ease;
        }

        .modal-footer .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* 日历模态框动画效果 */
        .modal.fade .modal-dialog {
            transform: scale(0.8);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal.show .modal-dialog {
            transform: scale(1);
            opacity: 1;
        }

        /* 月份切换动画 */
        @keyframes slideInRight {
            from {
                transform: translateX(30px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-30px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* 输入框过渡效果 */
        #customApiInput {
            transition: all 0.3s ease;
        }

        #customApiInput.show {
            transform: translateY(0);
            opacity: 1;
        }

        #customApiInput.hide {
            transform: translateY(-10px);
            opacity: 0;
        }

        /* 添加通知容器样式 */
        .notification-container {
            z-index: 1050;
        }

        .accordion-button {
            background: transparent !important;
        }

        .accordion-button:not(.collapsed) {
            color: rgb(147, 151, 255) !important;
        }

        .list-group-item {
            border: none;
            margin-bottom: 8px;
            border-radius: 8px !important;
            transition: all 0.3s ease;
        }

        /* 只针对定时任务的列表项应用深色样式 */
        #schedule-settings .list-group-item {
            background: rgba(30, 41, 59, 0.5);
            color: #fff;
        }

        #schedule-settings .list-group-item:hover {
            background: rgba(30, 41, 59, 0.8) !important;
            transform: translateX(5px);
        }

        /* 监听用户列表使用默认颜色 */
        #selected_users_LISTEN_LIST .list-group-item {
            background: var(--bs-list-group-bg);
            color: var(--bs-body-color);
        }

        /* 深色模式下的特定样式 */
        [data-bs-theme="dark"] #selected_users_LISTEN_LIST .list-group-item {
            background: rgba(30, 41, 59, 0.5);
            color: #fff;
        }

        /* 配置项样式 */
        .form-label {
            transition: all 0.3s ease;
        }

        .form-label:hover {
            color: var(--primary-color);
        }

        .badge {
            transition: all 0.3s ease;
        }

        .badge:hover {
            transform: scale(1.1);
        }

        /* 列表项动画 */
        .list-group-item {
            transition: all 0.3s ease;
        }

        .list-group-item:hover {
            transform: translateX(5px);
            background: rgba(var(--bs-primary-rgb), 0.1);
        }

        /* 按钮动画 */
        .btn {
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* 输入框动画 */
        .form-control {
            transition: all 0.3s ease;
        }

        .form-control:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* 移除遮罩相关样式 */
        .modal-backdrop-custom {
            display: none !important;
        }

        /* 时间选择器样式 */
        .time-display {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-display:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .time-display:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* 时间选项样式 */
        .time-option {
            padding: 8px 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 15px;
            border-radius: 8px;
            margin: 2px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            /* 新增点击态样式 */
            position: relative;
            overflow: hidden;
        }

        .time-option:hover {
            background-color: rgba(var(--bs-primary-rgb), 0.1);
            transform: translateX(2px);
        }

        .time-option.selected {
            background-color: var(--bs-primary);
            color: white;
            transform: scale(1.05);
            /* 新增选中动画 */
            animation: optionSelect 0.3s ease;
        }

        /* 新增点击波纹效果 */
        .time-option::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: width 0.3s, height 0.3s, opacity 0.3s;
        }

        .time-option:active::after {
            width: 100px;
            height: 100px;
            opacity: 1;
            transition: none;
        }

        @keyframes optionSelect {
            0% {
                transform: scale(0.95);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1.05);
            }
        }

        .time-option.clicking {
            transform: scale(0.95);
        }

        /* 修改模态框样式 */
        .time-picker-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1050;
            display: none;
            transition: opacity 0.3s ease;
            opacity: 0;
            max-height: 420px;
        }

        .time-picker-modal.show {
            opacity: 1;
        }

        .time-picker-content {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .time-picker-modal.show .time-picker-content {
            transform: scale(1);
        }

        /* 时间滑块样式 */
        .token-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
            outline: none;
            transition: all 0.3s ease;
        }

        .token-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
            border: 2px solid #0d6efd;
        }

        .token-slider::-moz-range-track {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
        }

        .token-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
            border: 2px solid #0d6efd;
        }

        .token-slider::-webkit-slider-thumb:hover {
            background: #f8f9fa;
            box-shadow: 0 0 8px rgba(13, 110, 253, 0.5);
            transform: scale(1.1);
        }

        .token-slider:active {
            opacity: 0.8;
        }

        .token-value {
            transition: all 0.2s ease;
        }

        .token-value.updating {
            color: #0d6efd;
            transform: scale(1.1);
        }

        /* 温度滑块样式 */
        .temperature-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right,
                    #3498db 0%,
                    #3498db 60%,
                    #9b59b6 70%,
                    #e74c3c 80%,
                    #e74c3c 100%);
            outline: none;
            transition: all 0.3s ease;
        }

        .temperature-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
            border: 2px solid #0d6efd;
        }

        .temperature-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
            border: 2px solid #0d6efd;
        }

        .temperature-value {
            transition: all 0.2s ease;
        }

        .temperature-value.updating {
            color: #0d6efd;
            transform: scale(1.1);
        }

        .slider-labels {
            color: #6c757d;
            font-size: 0.875rem;
        }

        .slider-labels .low {
            color: #3498db;
        }

        .slider-labels .high {
            color: #e74c3c;
        }

        /* 时间选择器容器样式 */
        .time-columns-container {
            display: flex;
            max-height: 150px;
            overflow: hidden;
        }

        .time-option {
            display: block;
            width: 100%;
        }

        .time-columns {
            display: flex;
            height: 150px;
            overflow: hidden;
            background: var(--bs-modal-bg);
            border-radius: 12px;
            padding: 8px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
            width: 100%;
            /* 确保宽度100% */
            gap: 12px;
            /* 添加列之间的间距 */
            padding: 0 12px;
            /* 增加左右内边距 */
        }

        .modal-footer {
            margin-top: 60px;
        }

        .time-column {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            /* 禁止横向滚动 */
            text-align: center;
            scrollbar-width: thin;
            padding: 0 4px;
            position: relative;
            min-width: 0;
            /* 防止内容溢出 */
        }

        /* 修改分隔符样式 */
        .time-column:first-child::after {
            content: ':';
            position: absolute;
            right: -8px;
            /* 调整位置 */
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: var(--bs-primary);
            font-weight: bold;
        }

        /* 模态框基础样式 */
        .modal {
            background: none !important;
        }

        .modal-backdrop {
            display: none !important;
        }

        .time-picker-content {
            border-radius: 16px !important;
            border: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            background: var(--bs-modal-bg);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .modal.show .time-picker-content {
            transform: scale(1);
        }

        .modal .time-picker-content {
            transform: scale(0.95);
        }

        /* 调整模态框内容边距 */
        .modal-body {
            padding: 1rem 1rem !important;
            max-height: 180px;
            /* 减小内边距 */
        }

        /* 调整头部和底部按钮区域的内边距 */
        .modal-header,
        .modal-footer {
            padding: 1rem !important;
        }

        /* 优化时间显示 */
        .time-header {
            font-size: 2rem !important;
            /* 增大字号 */
            letter-spacing: 2px;
            /* 增加字间距 */
        }
    </style>
    <script defer src="http://umami.kourichat.com/script.js"
        data-website-id="319cc5bc-c057-4f6c-8bc4-4af5e110add1"></script>
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/dark-mode.js"></script>
    <script>
        // 模型配置相关函数
        let modelConfigs = null;

        // 获取配置数据
        async function fetchModelConfigs ()
        {
            try
            {
                const response = await fetch( '/get_model_configs' );
                const data = await response.json();
                modelConfigs = data;
                initializeSelects();
            } catch ( error )
            {
                console.error( '获取配置失败:', error );
            }
        }

        // 初始化选择框
        function initializeSelects ()
        {
            if ( !modelConfigs ) return;

            // 初始化API提供商选择框
            const apiSelect = document.getElementById( 'api_provider_select' );
            if ( !apiSelect ) return;

            apiSelect.innerHTML = '<option value="">请选择API提供商</option>';
            apiSelect.innerHTML += '<option value="custom">自定义API提供商</option>';

            // 按优先级排序并添加选项
            modelConfigs.api_providers
                .sort( ( a, b ) => a.priority - b.priority )
                .forEach( provider =>
                {
                    if ( provider.status === 'active' )
                    {
                        apiSelect.innerHTML += `<option value="${ provider.id }"
                            data-url="${ provider.url }"
                            data-register="${ provider.register_url }"
                            >${ provider.name }</option>`;
                    }
                } );

            // 根据当前配置设置初始值
            const baseUrlElement = document.getElementById( 'DEEPSEEK_BASE_URL' );
            if ( baseUrlElement )
            {
                const currentUrl = baseUrlElement.value;
                const currentProvider = modelConfigs.api_providers.find( p => p.url === currentUrl );

                if ( currentProvider )
                {
                    apiSelect.value = currentProvider.id;
                    updateApiProvider( currentProvider.id );
                } else if ( currentUrl )
                {
                    apiSelect.value = 'custom';
                    showCustomApiInput( currentUrl );
                }
            }
        }

        // 显示自定义API输入框
        function showCustomApiInput ( value = '' )
        {
            const customApiInput = document.getElementById( 'customApiInput' );
            if ( !customApiInput ) return;

            customApiInput.style.display = 'block';
            const inputElement = customApiInput.querySelector( 'input' );

            if ( value )
            {
                inputElement.value = value;
            } else
            {
                // 清空输入框内容
                inputElement.value = '';
            }

            // 绑定输入框的 change 事件
            inputElement.onchange = function ()
            {
                updateCustomApi( inputElement.value );
            };
        }

        // 更新模型选择框
        async function updateModelSelect ( providerId )
        {
            // 更新模型选择框
            const modelSelect = document.getElementById( 'model_select' );
            const modelInput = document.getElementById( 'MODEL' );
            const customModelInput = document.getElementById( 'customModelInput' );

            if ( !modelSelect || !modelInput || !customModelInput ) return;

            modelSelect.innerHTML = '<option value="">请选择模型</option>';

            if ( providerId === 'custom' )
            {
                modelSelect.innerHTML += '<option value="custom">自定义模型</option>';
                modelSelect.value = 'custom';
                customModelInput.style.display = 'block';
                const currentValue = modelInput.value;
                if ( currentValue && currentValue !== 'custom' )
                {
                    customModelInput.querySelector( 'input' ).value = currentValue;
                }
                return;
            }

            if ( !providerId )
            {
                modelInput.value = '';
                return;
            }

            try
            {
                // 如果是 Ollama，尝试获取本地模型列表
                if ( providerId === 'ollama' )
                {
                    try
                    {
                        const response = await fetch( 'http://localhost:11434/api/tags' );
                        if ( response.ok )
                        {
                            const data = await response.json();
                            const ollamaModels = data.models || [];
                            ollamaModels.forEach( model =>
                            {
                                modelSelect.innerHTML += `
                                    <option value="${ model.name }"
                                        data-type="chat"
                                        data-context-length="16000"
                                        >${ model.name }</option>`;
                            } );
                        }
                    } catch ( error )
                    {
                        console.error( '获取Ollama模型列表失败:', error );
                        // 如果获取失败，使用配置文件中的默认模型
                        const defaultModels = modelConfigs.models[ providerId ] || [];
                        defaultModels.forEach( model =>
                        {
                            if ( model.status === 'active' )
                            {
                                modelSelect.innerHTML += `
                                    <option value="${ model.id }"
                                        data-type="${ model.type }"
                                        data-context-length="${ model.context_length }"
                                        >${ model.name }</option>`;
                            }
                        } );
                    }
                } else
                {
                    // 其他提供商使用配置文件中的模型列表
                    const providerModels = modelConfigs.models[ providerId ] || [];
                    providerModels.forEach( model =>
                    {
                        if ( model.status === 'active' )
                        {
                            modelSelect.innerHTML += `
                                <option value="${ model.id }"
                                    data-type="${ model.type }"
                                    data-context-length="${ model.context_length }"
                                    >${ model.name }</option>`;
                        }
                    } );
                }

                // 添加自定义选项
                modelSelect.innerHTML += '<option value="custom">自定义模型</option>';

                // 设置当前选中的模型
                const currentModel = modelInput.value;
                const modelOptions = Array.from( modelSelect.options );
                const modelExists = modelOptions.some( option => option.value === currentModel );

                if ( modelExists )
                {
                    modelSelect.value = currentModel;
                    customModelInput.style.display = 'none';
                } else if ( currentModel )
                {
                    modelSelect.value = 'custom';
                    customModelInput.style.display = 'block';
                    customModelInput.querySelector( 'input' ).value = currentModel;
                } else
                {
                    // 如果没有当前模型，选择第一个可用的模型
                    const firstModel = modelOptions.find( option => option.value && option.value !== 'custom' );
                    if ( firstModel )
                    {
                        modelSelect.value = firstModel.value;
                        modelInput.value = firstModel.value;
                        customModelInput.style.display = 'none';
                    }
                }

                // 触发change事件
                const event = new Event( 'change', { bubbles: true } );
                modelSelect.dispatchEvent( event );

            } catch ( error )
            {
                console.error( '更新模型选择失败:', error );
            }
        }

        // 更新模型
        function updateModel ( value )
        {
            const modelInput = document.getElementById( 'MODEL' );
            const customModelInput = document.getElementById( 'customModelInput' );

            if ( !modelInput || !customModelInput ) return;

            if ( value === 'custom' )
            {
                customModelInput.style.display = 'block';
                // 保持当前值不变，让用户可以编辑
                const currentValue = modelInput.value;
                if ( currentValue && currentValue !== 'custom' )
                {
                    customModelInput.querySelector( 'input' ).value = currentValue;
                }
            } else
            {
                customModelInput.style.display = 'none';
                modelInput.value = value;
                // 触发change事件
                const event = new Event( 'change', { bubbles: true } );
                modelInput.dispatchEvent( event );
            }
        }

        // 更新自定义模型
        function updateCustomModel ( value )
        {
            const modelInput = document.getElementById( 'MODEL' );
            if ( !modelInput ) return;

            if ( value.trim() )
            {
                modelInput.value = value.trim();
                // 触发change事件
                const event = new Event( 'change', { bubbles: true } );
                modelInput.dispatchEvent( event );
            }
        }

        // 更新API提供商
        function updateApiProvider ( value )
        {
            const baseUrlInput = document.getElementById( 'DEEPSEEK_BASE_URL' );
            const customApiInput = document.getElementById( 'customApiInput' );
            const registerLinks = document.getElementById( 'register_links' );
            const modelSelect = document.getElementById( 'model_select' );

            if ( !baseUrlInput || !customApiInput || !registerLinks ) return;

            // 重置所有状态
            customApiInput.style.display = 'none';
            registerLinks.classList.add( 'd-none' );
            registerLinks.innerHTML = '';

            // 处理自定义选项
            if ( value === 'custom' )
            {
                showCustomApiInput();
                updateModelSelect( 'custom' );
                // 当选择自定义时，清空API URL输入框
                baseUrlInput.value = '';
                return;
            }

            // 处理未选择情况
            if ( !value )
            {
                updateModelSelect( '' );
                return;
            }

            // 获取选中的提供商配置
            const selectedOption = document.querySelector( `#api_provider_select option[value="${ value }"]` );
            if ( !selectedOption ) return;

            // 更新API URL
            const apiUrl = selectedOption.dataset.url;
            baseUrlInput.value = apiUrl;

            // 添加标记是否为 Ollama
            if ( value === 'ollama' )
            {
                baseUrlInput.dataset.isOllama = 'true';
            } else
            {
                baseUrlInput.dataset.isOllama = 'false';
            }

            // 创建注册按钮
            const registerUrl = selectedOption.dataset.register;
            if ( registerUrl )
            {
                const link = document.createElement( 'a' );
                link.href = registerUrl;
                link.className = 'btn btn-outline-primary w-100';
                link.target = '_blank';
                link.innerHTML = `<i class="bi bi-box-arrow-up-right me-1"></i>前往${ selectedOption.textContent.replace( ' API', '' ) }注册`;
                registerLinks.innerHTML = '';
                registerLinks.appendChild( link );
                registerLinks.classList.remove( 'd-none' );
            }

            // 更新模型选择框
            updateModelSelect( value );
        }

        // 更新自定义API
        function updateCustomApi ( value )
        {
            const baseUrlInput = document.getElementById( 'DEEPSEEK_BASE_URL' );
            if ( baseUrlInput )
            {
                baseUrlInput.value = value;
            }
        }

        // 更新温度函数
        function updateTemperature ( key, value )
        {
            // 将字符串转换为数字
            const numValue = parseFloat( value );

            // 更新显示值
            const displayElement = document.getElementById( key + '_display' );
            if ( displayElement )
            {
                displayElement.classList.add( 'updating' );
                displayElement.textContent = numValue;
                setTimeout( () =>
                {
                    displayElement.classList.remove( 'updating' );
                }, 300 );
            }

            // 更新隐藏的实际提交值
            const inputElement = document.getElementById( key );
            if ( inputElement )
            {
                inputElement.value = numValue;
                // 触发 change 事件以确保表单能捕获到值的变化
                const event = new Event( 'change', { bubbles: true } );
                inputElement.dispatchEvent( event );
            }

            // 调试输出
            console.log( `Temperature updated - key: ${ key }, value: ${ numValue }, type: ${ typeof numValue }` );
            console.log( `Hidden input value: ${ document.getElementById( key ).value }` );
        }

        // 更新token函数
        function updateToken ( key, value )
        {
            // 将字符串转换为整数
            const numValue = parseInt( value );

            // 更新显示值
            const displayElement = document.getElementById( key + '_display' );
            if ( displayElement )
            {
                displayElement.classList.add( 'updating' );
                displayElement.textContent = numValue;
                setTimeout( () =>
                {
                    displayElement.classList.remove( 'updating' );
                }, 300 );
            }

            // 更新隐藏的实际提交值
            const inputElement = document.getElementById( key );
            if ( inputElement )
            {
                inputElement.value = numValue;
            }
        }

        // 用户列表管理函数
        function addNewUser ( key )
        {
            const inputElement = document.getElementById( 'input_' + key );
            if ( !inputElement ) return;

            const newValue = inputElement.value.trim();

            if ( newValue )
            {
                const targetElement = document.getElementById( key );
                const userListElement = document.getElementById( 'selected_users_' + key );

                if ( !targetElement || !userListElement ) return;

                const currentValues = targetElement.value ? targetElement.value.split( ',' ) : [];
                if ( !currentValues.includes( newValue ) )
                {
                    currentValues.push( newValue );
                    targetElement.value = currentValues.join( ',' );

                    // 添加到用户列表显示
                    const userDiv = document.createElement( 'div' );
                    userDiv.className = 'list-group-item d-flex justify-content-between align-items-center';
                    userDiv.innerHTML = `
                        ${ newValue }
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeUser('${ key }', '${ newValue }')">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    `;
                    userListElement.appendChild( userDiv );

                    // 清空输入框
                    inputElement.value = '';
                }
            }

            if ( typeof updateTaskChatIdOptions === 'function' )
            {
                updateTaskChatIdOptions();
            }
        }

        function removeUser ( key, userToRemove )
        {
            const targetElement = document.getElementById( key );
            const userListElement = document.getElementById( 'selected_users_' + key );

            if ( !targetElement || !userListElement ) return;

            // 更新隐藏的input值
            let currentValues = targetElement.value ? targetElement.value.split( ',' ) : [];
            currentValues = currentValues.filter( user => user !== userToRemove );
            targetElement.value = currentValues.join( ',' );

            // 从显示列表中移除
            const userElements = userListElement.getElementsByClassName( 'list-group-item' );
            for ( let element of userElements )
            {
                if ( element.textContent.trim() === userToRemove )
                {
                    element.remove();
                    break;
                }
            }

            if ( typeof updateTaskChatIdOptions === 'function' )
            {
                updateTaskChatIdOptions();
            }
        }

        // 时间选择器相关函数
        let timeSelections = {};

        function showTimePicker ( key )
        {
            const modal = document.getElementById( 'timePickerModal_' + key );
            if ( !modal ) return;

            // 初始化选择状态
            if ( !timeSelections[ key ] )
            {
                const currentInput = document.getElementById( key );
                if ( currentInput )
                {
                    let currentValue = currentInput.value;
                    if ( currentValue )
                    {
                        // 处理可能的非字符串格式
                        currentValue = String( currentValue );

                        // 格式化时间值
                        if ( !currentValue.includes( ':' ) )
                        {
                            if ( /^\d+$/.test( currentValue ) )
                            {
                                if ( currentValue.length === 4 )
                                {
                                    currentValue = `${ currentValue.substring( 0, 2 ) }:${ currentValue.substring( 2, 4 ) }`;
                                } else if ( currentValue.length === 3 )
                                {
                                    currentValue = `0${ currentValue.substring( 0, 1 ) }:${ currentValue.substring( 1, 3 ) }`;
                                } else if ( currentValue.length === 2 )
                                {
                                    currentValue = `${ currentValue }:00`;
                                } else if ( currentValue.length === 1 )
                                {
                                    currentValue = `0${ currentValue }:00`;
                                }
                            }
                        }

                        // 更新显示值
                        document.getElementById( key + '_display' ).value = currentValue;
                        document.getElementById( key ).value = currentValue;

                        // 解析时间
                        const [ hour, minute ] = currentValue.includes( ':' ) ? currentValue.split( ':' ) : [ currentValue, '00' ];
                        timeSelections[ key ] = {
                            hour: hour || '00',
                            minute: minute || '00'
                        };
                    } else
                    {
                        timeSelections[ key ] = { hour: '00', minute: '00' };
                    }
                }
            }

            // 计算页面中心位置
            const windowHeight = window.innerHeight;
            const modalHeight = 400;
            const scrollPosition = window.pageYOffset;
            const targetScrollPosition = scrollPosition + ( windowHeight - modalHeight ) / 2;

            // 平滑滚动到目标位置
            window.scrollTo( {
                top: targetScrollPosition,
                behavior: 'smooth'
            } );

            // 显示模态框
            setTimeout( () =>
            {
                modal.style.display = 'block';
                requestAnimationFrame( () => modal.classList.add( 'show' ) );
            }, 300 );

            // 高亮选中时间
            highlightSelectedTime( key );

            // 滚动到选中位置
            setTimeout( () =>
            {
                scrollToSelected( key );
            }, 100 );
        }

        function selectTimeOption ( key, type, value )
        {
            if ( !timeSelections[ key ] )
            {
                timeSelections[ key ] = { hour: '00', minute: '00' };
            }

            // 更新选择的时间
            timeSelections[ key ][ type ] = value;

            // 更新显示
            updateTimeDisplay( key );

            // 高亮选中时间
            highlightSelectedTime( key );
        }

        function updateTimeDisplay ( key )
        {
            const selection = timeSelections[ key ];
            if ( !selection ) return;

            const timeString = `${ selection.hour }:${ selection.minute }`;
            const headerElement = document.querySelector( '.time-header-' + key );
            if ( headerElement )
            {
                headerElement.textContent = timeString;
            }
        }

        function highlightSelectedTime ( key )
        {
            const selection = timeSelections[ key ];
            if ( !selection ) return;

            // 移除所有选中状态
            document.querySelectorAll( '.time-option' ).forEach( option =>
            {
                option.classList.remove( 'selected' );
            } );

            // 高亮小时选项
            const hourOption = document.querySelector( `.time-column-${ key } .time-option-hour[data-value="${ selection.hour }"]` );
            if ( hourOption )
            {
                hourOption.classList.add( 'selected' );
            }

            // 高亮分钟选项
            const minuteOption = document.querySelector( `.time-column-${ key } .time-option-minute[data-value="${ selection.minute }"]` );
            if ( minuteOption )
            {
                minuteOption.classList.add( 'selected' );
            }
        }

        function scrollToSelected ( key )
        {
            const selection = timeSelections[ key ];
            if ( !selection ) return;

            const columns = document.querySelectorAll( `.time-column-${ key }` );

            if ( columns.length >= 2 )
            {
                // 小时列滚动
                const hourOption = columns[ 0 ].querySelector( `.time-option-hour[data-value="${ selection.hour }"]` );
                if ( hourOption )
                {
                    columns[ 0 ].scrollTop = hourOption.offsetTop - columns[ 0 ].offsetHeight / 2 + hourOption.offsetHeight / 2;
                }

                // 分钟列滚动
                const minuteOption = columns[ 1 ].querySelector( `.time-option-minute[data-value="${ selection.minute }"]` );
                if ( minuteOption )
                {
                    columns[ 1 ].scrollTop = minuteOption.offsetTop - columns[ 1 ].offsetHeight / 2 + minuteOption.offsetHeight / 2;
                }
            }
        }

        function closeTimePicker ( key )
        {
            const modal = document.getElementById( 'timePickerModal_' + key );
            if ( modal )
            {
                modal.classList.remove( 'show' );

                setTimeout( () =>
                {
                    modal.style.display = 'none';
                }, 300 );
            }
        }

        function confirmTimePicker ( key )
        {
            const selection = timeSelections[ key ];
            if ( !selection ) return;

            const timeString = `${ selection.hour }:${ selection.minute }`;
            document.getElementById( key + '_display' ).value = timeString;
            document.getElementById( key ).value = timeString;
            closeTimePicker( key );
        }

        // 初始化
        document.addEventListener( 'DOMContentLoaded', function ()
        {
            // 获取模型配置
            fetchModelConfigs();

            // 初始化温度值
            const temperatureSlider = document.getElementById( 'TEMPERATURE_slider' );
            if ( temperatureSlider )
            {
                updateTemperature( 'TEMPERATURE', temperatureSlider.value );
            }

            // 设置时间选择器关闭按钮事件
            initTimePickerCloseButtons();
        } );

        function initTimePickerCloseButtons ()
        {
            [ 'QUIET_TIME_START', 'QUIET_TIME_END' ].forEach( key =>
            {
                const modal = document.getElementById( 'timePickerModal_' + key );
                if ( !modal ) return;

                const closeBtn = modal.querySelector( '.btn-close' );
                const cancelBtn = modal.querySelector( '.btn-light' );

                if ( closeBtn )
                {
                    closeBtn.onclick = () => closeTimePicker( key );
                }
                if ( cancelBtn )
                {
                    cancelBtn.onclick = () => closeTimePicker( key );
                }
            } );
        }
    </script>
</head>

<body>
    {% include 'navbar.html' %}

    <main class="container-fluid py-4">
        <div class="row gx-3">
            <!-- 左侧基础配置 -->
            <div class="col-md-6 col-lg-6 pe-md-2 pe-lg-2">
                <div class="config-section h-100">
                    <h4 class="mb-4 d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-gear-fill me-2"></i>基础配置
                        </div>
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
                            data-bs-target="#historyConfigModal">
                            <i class="bi bi-clock-history me-2"></i>历史配置
                        </button>
                    </h4>
                    <form id="configForm">
                        {% for group_name, configs in config_groups.items() %}
                        {% if group_name == '基础配置' %}
                        <div class="accordion mb-3">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#{{ group_name|replace(' ', '-') }}">
                                        {{ group_name }}
                                    </button>
                                </h2>
                                <div id="{{ group_name|replace(' ', '-') }}" class="accordion-collapse collapse show">
                                    <div class="accordion-body">
                                        {% for key, config in configs.items() %}
                                        <div class="mb-4">
                                            <label class="form-label">
                                                <span class="badge badge-info rounded-pill me-2"
                                                    data-bs-toggle="tooltip" title="{{ key }}">
                                                    <i class="bi bi-info-circle"></i>
                                                </span>
                                                {{ config.description }}
                                            </label>
                                            {% if key == 'LISTEN_LIST' %}
                                            <!-- LISTEN_LIST 相关代码 -->
                                            <div class="mb-2">
                                                <div class="input-group mb-2">
                                                    <input type="text" class="form-control" id="input_{{ key }}"
                                                        placeholder="请输入要监听的用户">
                                                    <button class="btn btn-primary" type="button"
                                                        onclick="addNewUser('{{ key }}')" title="添加用户">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </div>
                                                <div id="selected_users_{{ key }}" class="list-group">
                                                    {% if config.value %}
                                                    {% for user in config.value %}
                                                    {% if user %}
                                                    <div
                                                        class="list-group-item d-flex justify-content-between align-items-center">
                                                        {{ user }}
                                                        <button type="button" class="btn btn-danger btn-sm"
                                                            onclick="removeUser('{{ key }}', '{{ user }}')"
                                                            title="删除用户">
                                                            <i class="bi bi-x-lg"></i>
                                                        </button>
                                                    </div>
                                                    {% endif %}
                                                    {% endfor %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <input type="text" class="form-control" id="{{ key }}" name="{{ key }}"
                                                value="{{ config.value|join(',') }}" placeholder="多个值用英文逗号分隔" readonly
                                                style="display: none;">
                                            {% elif key == 'DEEPSEEK_BASE_URL' %}
                                            <div class="mb-3">
                                                <select class="form-select mb-2" id="api_provider_select"
                                                    onchange="updateApiProvider(this.value)" aria-label="选择API提供商">
                                                    <option value="">请选择API提供商</option>
                                                    <option value="custom">自定义API提供商</option>
                                                </select>

                                                <!-- 添加自定义 API 输入框 -->
                                                <div id="customApiInput" class="mb-2" style="display: none;">
                                                    <input type="text" class="form-control" placeholder="请输入自定义 API 地址"
                                                        onchange="updateCustomApi(this.value)">
                                                </div>

                                                <!-- 注册链接容器 -->
                                                <div id="register_links" class="d-none">
                                                    <!-- 注册链接将通过JavaScript动态添加 -->
                                                </div>

                                                <input type="text" class="form-control" id="{{ key }}" name="{{ key }}"
                                                    value="{{ config.value }}" readonly style="display: none;">
                                            </div>
                                            {% elif key == 'PROMPT_ENHANCEMENT' %}
                                            <!-- PROMPT_ENHANCEMENT 相关代码 -->
                                            <select class="form-select" id="{{ key }}" name="{{ key }}">
                                                <option value="True" {% if config.value %}selected{% endif %}>启用
                                                </option>
                                                <option value="False" {% if not config.value %}selected{% endif %}>停用
                                                </option>
                                            </select>
                                            {% elif key == 'AVATAR_DIR' %}
                                            <!-- AVATAR_DIR 相关代码 -->
                                            <select class="form-select" id="{{ key }}" name="{{ key }}">
                                                {% for option in config.options %}
                                                <option value="{{ option }}" {% if option==config.value %}selected{%
                                                    endif %}>
                                                    {{ option.split('/')[-1] }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            {% elif config.value is boolean %}
                                            <div class="form-check form-switch d-flex align-items-center"
                                                style="padding: 6px 0; min-height: 38px;">
                                                <input class="form-check-input me-2" type="checkbox" role="switch"
                                                    id="{{ key }}" name="{{ key }}" {% if config.value %}checked{% endif
                                                    %} style="margin: 0;">
                                                <label class="form-check-label mb-0" for="{{ key }}"
                                                    style="line-height: 24px;">
                                                    {{ '启用' if config.value else '停用' }}
                                                </label>
                                            </div>
                                            {% elif key == 'MODEL' %}
                                            <div class="mb-3">
                                                <select class="form-select mb-2" id="model_select"
                                                    onchange="updateModel(this.value)" aria-label="选择模型">
                                                    <option value="">请选择模型</option>
                                                </select>

                                                <!-- 添加自定义模型输入框 -->
                                                <div id="customModelInput" class="mb-2" style="display: none;">
                                                    <input type="text" class="form-control" placeholder="请输入自定义模型名称"
                                                        onchange="updateCustomModel(this.value)"
                                                        value="{{ config.value }}">
                                                </div>

                                                <input type="hidden" class="form-control" id="{{ key }}"
                                                    name="{{ key }}" value="{{ config.value }}">
                                            </div>
                                            {% elif config.type == "number" %}
                                            {% if key == 'MAX_TOKEN' %}
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span>当前值: <strong id="{{ key }}_display" class="token-value">{{
                                                            config.value }}</strong></span>
                                                </div>
                                                <input type="range" class="token-slider" id="{{ key }}_slider" min="50"
                                                    max="5000" step="5" value="{{ config.value }}"
                                                    oninput="updateToken('{{ key }}', this.value)"
                                                    style="cursor: pointer;" title="最大token数滑动条">
                                                <div class="d-flex justify-content-between"
                                                    style="color: #6c757d; font-size: 0.875rem;">
                                                    <span>50</span>
                                                    <span>5000</span>
                                                </div>
                                                <!-- 隐藏的实际提交值输入框 -->
                                                <input type="hidden" id="{{ key }}" name="{{ key }}"
                                                    value="{{ config.value }}">
                                            </div>
                                            {% elif key == 'TEMPERATURE' %}
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span>当前值: <strong id="{{ key }}_display"
                                                            class="temperature-value">{{ config.value }}</strong></span>
                                                </div>
                                                <input type="range" class="temperature-slider" id="{{ key }}_slider"
                                                    min="0.00" max="1.70" step="0.01" value="{{ config.value }}"
                                                    oninput="updateTemperature('{{ key }}', this.value)"
                                                    style="cursor: pointer;" title="温度参数滑动条">
                                                <div class="d-flex justify-content-between slider-labels">
                                                    <span class="low">0.0</span>
                                                    <span class="high">1.7</span>
                                                </div>
                                                <!-- 隐藏的实际提交值输入框 -->
                                                <input type="hidden" id="{{ key }}" name="{{ key }}"
                                                    value="{{ config.value }}">
                                            </div>
                                            {% else %}
                                            <input type="number" class="form-control" id="{{ key }}" name="{{ key }}"
                                                value="{{ config.value }}" step="0.1" {% if config.min is defined
                                                %}min="{{ config.min }}" {% endif %} {% if config.max is defined
                                                %}max="{{ config.max }}" {% endif %}>
                                            {% endif %}
                                            {% elif key == 'MOONSHOT_API_KEY' %}
                                            <div class="mb-3">
                                                <input type="text" class="form-control mb-2" id="{{ key }}"
                                                    name="{{ key }}" value="{{ config.value }}"
                                                    placeholder="请输入Kourichat API 密钥">
                                                <a href="https://platform.moonshot.cn/console/api-keys"
                                                    class="btn btn-primary w-100" target="_blank" rel="noopener">
                                                    <i class="bi bi-box-arrow-up-right me-1"></i>点我注册
                                                </a>
                                            </div>
                                            {% elif key == 'QUIET_TIME_START' or key == 'QUIET_TIME_END' %}
                                            <div class="mb-3">
                                                <input type="text" class="form-control time-display"
                                                    id="{{ key }}_display" value="{{ config.value }}" readonly
                                                    placeholder="请选择时间" data-key="{{ key }}"
                                                    onclick="showTimePicker(this.dataset.key)">
                                                <input type="hidden" id="{{ key }}" name="{{ key }}"
                                                    value="{{ config.value }}">

                                                <!-- 时间选择器模态框 -->
                                                <div class="modal time-picker-modal" id="timePickerModal_{{ key }}"
                                                    tabindex="-1" aria-hidden="true" data-bs-backdrop="false">
                                                    <div class="modal-dialog modal-dialog-centered time-picker-content"
                                                        style="max-width: 300px;">
                                                        <div class="modal-content">
                                                            <div class="modal-header border-bottom-0">
                                                                <h5 class="modal-title">
                                                                    <i class="bi bi-clock me-2"></i>
                                                                    选择{{ '开始时间' if key == 'QUIET_TIME_START' else '结束时间'
                                                                    }}
                                                                </h5>
                                                                <button type="button" class="btn-close"
                                                                    data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body pt-0">
                                                                <div
                                                                    class="time-header-{{ key }} mb-3 text-center fs-4 fw-bold text-primary">
                                                                    {{ config.value }}
                                                                </div>
                                                                <div class="time-columns-container"
                                                                    style="max-height: 150px;">
                                                                    <div class="time-columns">
                                                                        <div class="time-column">
                                                                            {% for h in range(24) %}
                                                                            <div class="time-option time-option-hour"
                                                                                gap: 10px; padding-right: 5px; /*
                                                                                防止滚动条遮挡内容 */ } </style>
                                                                                <script defer
                                                                                    src="http://umami.kourichat.com/script.js"
                                                                                    data-website-id="319cc5bc-c057-4f6c-8bc4-4af5e110add1"></script>
                                                                                data-value="{{ '%02d' % h }}"
                                                                                data-key="{{ key }}"
                                                                                onclick="selectTimeOption(this.dataset.key,
                                                                                'hour', this.dataset.value)">{{ '%02d' %
                                                                                h }}
                                                                            </div>
                                                                            {% endfor %}
                                                                        </div>
                                                                        <div class="time-column">
                                                                            {% for m in range(0, 60, 1) %}
                                                                            <div class="time-option time-option-minute"
                                                                                data-value="{{ '%02d' % m }}"
                                                                                data-key="{{ key }}"
                                                                                onclick="selectTimeOption(this.dataset.key, 'minute', this.dataset.value)">
                                                                                {{ '%02d' % m }}</div>
                                                                            {% endfor %}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="modal-footer border-top-0">
                                                                <button type="button" class="btn btn-light"
                                                                    data-bs-dismiss="modal">取消</button>
                                                                <button type="button" class="btn btn-primary px-4"
                                                                    data-key="{{ key }}"
                                                                    onclick="confirmTimePicker(this.dataset.key)">确定</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% else %}
                                            <input type="text" class="form-control" id="{{ key }}" name="{{ key }}"
                                                value="{{ config.value }}">
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </form>
                </div>
            </div>

            <!-- 右侧其他配置 -->
            <div class="col-md-6 col-lg-6 ps-md-2 ps-lg-2">
                <div class="config-section h-100">
                    <h4 class="mb-4">
                        <i class="bi bi-sliders me-2"></i>高级配置
                    </h4>
                    <form id="otherConfigForm">
                        {% for group_name, configs in config_groups.items() %}
                        {% if group_name != '基础配置' and group_name != '定时任务配置' %} {# 排除定时任务配置 #}
                        <div class="accordion mb-3">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#{{ group_name|replace(' ', '-') }}">
                                        {{ group_name }}
                                    </button>
                                </h2>
                                <div id="{{ group_name|replace(' ', '-') }}" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        {% for key, config in configs.items() %}
                                        <div class="mb-4">
                                            <label class="form-label">
                                                <span class="badge badge-info rounded-pill me-2"
                                                    data-bs-toggle="tooltip" title="{{ key }}">
                                                    <i class="bi bi-info-circle"></i>
                                                </span>
                                                {{ config.description }}
                                            </label>
                                            {% if key == 'LISTEN_LIST' %}
                                            <!-- LISTEN_LIST 相关代码 -->
                                            <div class="mb-2">
                                                <div class="input-group mb-2">
                                                    <input type="text" class="form-control" id="input_{{ key }}"
                                                        placeholder="请输入要监听的用户">
                                                    <button class="btn btn-primary" type="button"
                                                        onclick="addNewUser('{{ key }}')" title="添加用户">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </div>
                                                <div id="selected_users_{{ key }}" class="list-group">
                                                    {% if config.value %}
                                                    {% for user in config.value %}
                                                    {% if user %}
                                                    <div
                                                        class="list-group-item d-flex justify-content-between align-items-center">
                                                        {{ user }}
                                                        <button type="button" class="btn btn-danger btn-sm"
                                                            onclick="removeUser('{{ key }}', '{{ user }}')"
                                                            title="删除用户">
                                                            <i class="bi bi-x-lg"></i>
                                                        </button>
                                                    </div>
                                                    {% endif %}
                                                    {% endfor %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <input type="text" class="form-control" id="{{ key }}" name="{{ key }}"
                                                value="{{ config.value|join(',') }}" placeholder="多个值用英文逗号分隔" readonly
                                                style="display: none;">
                                            {% elif key == 'DEEPSEEK_BASE_URL' %}
                                            <div class="mb-3">
                                                <select class="form-select mb-2" id="api_provider_select"
                                                    onchange="updateApiProvider(this.value)" aria-label="选择API提供商">
                                                    <option value="">请选择API提供商</option>
                                                    <option value="custom">自定义API提供商</option>
                                                </select>

                                                <!-- 添加自定义 API 输入框 -->
                                                <div id="customApiInput" class="mb-2" style="display: none;">
                                                    <input type="text" class="form-control" placeholder="请输入自定义 API 地址"
                                                        onchange="updateCustomApi(this.value)">
                                                </div>

                                                <!-- 注册链接容器 -->
                                                <div id="register_links" class="d-none">
                                                    <!-- 注册链接将通过JavaScript动态添加 -->
                                                </div>

                                                <input type="text" class="form-control" id="{{ key }}" name="{{ key }}"
                                                    value="{{ config.value }}" readonly style="display: none;">
                                            </div>
                                            {% elif key == 'PROMPT_ENHANCEMENT' %}
                                            <!-- PROMPT_ENHANCEMENT 相关代码 -->
                                            <select class="form-select" id="{{ key }}" name="{{ key }}">
                                                <option value="True" {% if config.value %}selected{% endif %}>启用
                                                </option>
                                                <option value="False" {% if not config.value %}selected{% endif %}>停用
                                                </option>
                                            </select>
                                            {% elif key == 'AVATAR_DIR' %}
                                            <!-- AVATAR_DIR 相关代码 -->
                                            <select class="form-select" id="{{ key }}" name="{{ key }}">
                                                {% for option in config.options %}
                                                <option value="{{ option }}" {% if option==config.value %}selected{%
                                                    endif %}>
                                                    {{ option.split('/')[-1] }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            {% elif config.value is boolean %}
                                            <div class="form-check form-switch d-flex align-items-center"
                                                style="padding: 6px 0; min-height: 38px;">
                                                <input class="form-check-input me-2" type="checkbox" role="switch"
                                                    id="{{ key }}" name="{{ key }}" {% if config.value %}checked{% endif
                                                    %} style="margin: 0;">
                                                <label class="form-check-label mb-0" for="{{ key }}"
                                                    style="line-height: 24px;">
                                                    {{ '启用' if config.value else '停用' }}
                                                </label>
                                            </div>
                                            {% elif key == 'MODEL' %}
                                            <div class="mb-3">
                                                <select class="form-select mb-2" id="model_select"
                                                    onchange="updateModel(this.value)" aria-label="选择模型">
                                                    <option value="">请选择模型</option>
                                                </select>

                                                <!-- 添加自定义模型输入框 -->
                                                <div id="customModelInput" class="mb-2" style="display: none;">
                                                    <input type="text" class="form-control" placeholder="请输入自定义模型名称"
                                                        onchange="updateCustomModel(this.value)"
                                                        value="{{ config.value }}">
                                                </div>

                                                <input type="hidden" class="form-control" id="{{ key }}"
                                                    name="{{ key }}" value="{{ config.value }}">
                                            </div>
                                            {% elif config.type == "number" %}
                                            {% if key == 'MAX_TOKEN' %}
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span>当前值: <strong id="{{ key }}_display" class="token-value">{{
                                                            config.value }}</strong></span>
                                                </div>
                                                <input type="range" class="token-slider" id="{{ key }}_slider" min="50"
                                                    max="5000" step="5" value="{{ config.value }}"
                                                    oninput="updateToken('{{ key }}', this.value)"
                                                    style="cursor: pointer;" title="最大token数滑动条">
                                                <div class="d-flex justify-content-between"
                                                    style="color: #6c757d; font-size: 0.875rem;">
                                                    <span>50</span>
                                                    <span>5000</span>
                                                </div>
                                                <!-- 隐藏的实际提交值输入框 -->
                                                <input type="hidden" id="{{ key }}" name="{{ key }}"
                                                    value="{{ config.value }}">
                                            </div>
                                            {% elif key == 'TEMPERATURE' %}
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span>当前值: <strong id="{{ key }}_display"
                                                            class="temperature-value">{{ config.value }}</strong></span>
                                                </div>
                                                <input type="range" class="temperature-slider" id="{{ key }}_slider"
                                                    min="0.00" max="1.70" step="0.01" value="{{ config.value }}"
                                                    oninput="updateTemperature('{{ key }}', this.value)"
                                                    style="cursor: pointer;" title="温度参数滑动条">
                                                <div class="d-flex justify-content-between slider-labels">
                                                    <span class="low">0.0</span>
                                                    <span class="high">1.7</span>
                                                </div>
                                                <!-- 隐藏的实际提交值输入框 -->
                                                <input type="hidden" id="{{ key }}" name="{{ key }}"
                                                    value="{{ config.value }}">
                                            </div>
                                            {% else %}
                                            <input type="number" class="form-control" id="{{ key }}" name="{{ key }}"
                                                value="{{ config.value }}" step="0.1" {% if config.min is defined
                                                %}min="{{ config.min }}" {% endif %} {% if config.max is defined
                                                %}max="{{ config.max }}" {% endif %}>
                                            {% endif %}
                                            {% elif key == 'MOONSHOT_API_KEY' %}
                                            <div class="mb-3">
                                                <input type="text" class="form-control mb-2" id="{{ key }}"
                                                    name="{{ key }}" value="{{ config.value }}"
                                                    placeholder="请输入 识图模型API 密钥">
                                                <a href="https://api.kourichat.com/" class="btn btn-primary w-100"
                                                    target="_blank" rel="noopener">
                                                    <i class="bi bi-box-arrow-up-right me-1"></i>点我注册
                                                </a>
                                            </div>
                                            {% elif key == 'QUIET_TIME_START' or key == 'QUIET_TIME_END' %}
                                            <div class="mb-3">
                                                <input type="text" class="form-control time-display"
                                                    id="{{ key }}_display" value="{{ config.value }}" readonly
                                                    placeholder="请选择时间" data-key="{{ key }}"
                                                    onclick="showTimePicker(this.dataset.key)">
                                                <input type="hidden" id="{{ key }}" name="{{ key }}"
                                                    value="{{ config.value }}">

                                                <!-- 时间选择器模态框 -->
                                                <div class="modal time-picker-modal" id="timePickerModal_{{ key }}"
                                                    tabindex="-1" aria-hidden="true" data-bs-backdrop="false">
                                                    <div class="modal-dialog modal-dialog-centered time-picker-content"
                                                        style="max-width: 300px;">
                                                        <div class="modal-content">
                                                            <div class="modal-header border-bottom-0">
                                                                <h5 class="modal-title">
                                                                    <i class="bi bi-clock me-2"></i>
                                                                    选择{{ '开始时间' if key == 'QUIET_TIME_START' else '结束时间'
                                                                    }}
                                                                </h5>
                                                                <button type="button" class="btn-close"
                                                                    data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body pt-0">
                                                                <div
                                                                    class="time-header mb-3 text-center fs-4 fw-bold text-primary">
                                                                    {{ config.value }}
                                                                </div>
                                                                <div class="time-columns-container"
                                                                    style="max-height: 150px">
                                                                    <div class="time-columns">
                                                                        <div class="time-column">
                                                                            {% for h in range(24) %}
                                                                            <div class="time-option time-option-hour"
                                                                                data-value="{{ '%02d' % h }}"
                                                                                data-key="{{ key }}"
                                                                                onclick="selectTimeOption(this.dataset.key, 'hour', this.dataset.value)">
                                                                                {{ '%02d' % h }}</div>
                                                                            {% endfor %}
                                                                        </div>
                                                                        <div class="time-column">
                                                                            {% for m in range(0, 60, 1) %}
                                                                            <div class="time-option time-option-minute"
                                                                                data-value="{{ '%02d' % m }}"
                                                                                data-key="{{ key }}"
                                                                                onclick="selectTimeOption(this.dataset.key, 'minute', this.dataset.value)">
                                                                                {{ '%02d' % m }}</div>
                                                                            {% endfor %}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="modal-footer border-top-0">
                                                                <button type="button" class="btn btn-light"
                                                                    data-bs-dismiss="modal">取消</button>
                                                                <button type="button" class="btn btn-primary px-4"
                                                                    data-key="{{ key }}"
                                                                    onclick="confirmTimePicker(this.dataset.key)">确定</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% else %}
                                            <input type="text" class="form-control" id="{{ key }}" name="{{ key }}"
                                                value="{{ config.value }}">
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}

                        <!-- 单独添加定时任务配置部分 -->
                        <div class="accordion mb-3">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#schedule-settings">
                                        定时任务配置
                                    </button>
                                </h2>
                                <div id="schedule-settings" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <!-- 定时任务配置的内容 -->
                                        <input type="hidden" id="TASKS" name="TASKS" value='{{ tasks_json|safe }}'>

                                        <!-- 添加和管理任务的按钮 -->
                                        <div class="mb-3 list-group">
                                            <a href="#" class="list-group-item list-group-item-action"
                                                data-bs-toggle="modal" data-bs-target="#addTaskModal"
                                                style="background: rgba(30, 41, 59, 0.5);">
                                                <i class="bi bi-plus-lg me-2"></i>
                                                添加定时任务
                                                <i class="bi bi-chevron-right float-end mt-1"></i>
                                            </a>
                                        </div>

                                        <!-- 任务列表管理按钮 -->
                                        <div class="mb-3 list-group">
                                            <a href="#" class="list-group-item list-group-item-action"
                                                data-bs-toggle="modal" data-bs-target="#taskListModal"
                                                style="background: rgba(30, 41, 59, 0.5);">
                                                <i class="bi bi-list-ul me-2"></i>
                                                任务列表管理
                                                <i class="bi bi-chevron-right float-end mt-1"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 添加RAG记忆配置部分 -->
                        <div class="accordion mb-3">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#rag-settings">
                                        RAG记忆配置
                                    </button>
                                </h2>
                                <div id="rag-settings" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <!-- API服务商选择 -->
                                        <div class="mb-3">
                                            <label class="form-label">
                                                <i class="bi bi-server me-2"></i>API服务商
                                            </label>
                                            <select class="form-select" id="rag_api_provider_select"
                                                onchange="updateRagApiProvider(this.value)">
                                                <option value="ciallo" data-url="https://api.ciallo.ac.cn/">KouriChat
                                                    API (亚太备选)</option>
                                                <option value="kourichat" data-url="https://api.kourichat.com">KouriChat
                                                    API (全球优化)</option>
                                                <option value="siliconflow" data-url="https://api.siliconflow.cn/v1">
                                                    硅基流动 API</option>
                                                <!--option value="kouri" data-url="https://api.kourichat.com/v1">KouriChat API</option-->
                                                <option value="custom">自定义 API</option>
                                            </select>
                                        </div>

                                        <!-- 自定义API URL输入框 -->
                                        <div class="mb-3" id="rag_customApiInput" style="display: none;">
                                            <label class="form-label">
                                                <i class="bi bi-link-45deg me-2"></i>自定义 API URL
                                            </label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="rag_custom_url"
                                                    placeholder="https://your-api-server.com/v1/embeddings"
                                                    oninput="updateRagCustomApiUrl(this.value)">
                                            </div>
                                        </div>

                                        <!-- API密钥 -->
                                        <div class="mb-3">
                                            <label for="RAG_API_KEY" class="form-label">
                                                <i class="bi bi-key me-2"></i>API密钥
                                            </label>
                                            <div class="password-input-group">
                                                <input type="password" class="form-control" id="RAG_API_KEY"
                                                    name="RAG_API_KEY" placeholder="sk-..." autocomplete="off">
                                                <button type="button" class="password-toggle"
                                                    onclick="togglePasswordVisibility('RAG_API_KEY')">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                            </div>
                                            <div class="form-text">嵌入API密钥，不填写则使用LLM模块配置</div>
                                        </div>

                                        <!-- 隐藏的API URL字段 -->
                                        <input type="hidden" id="RAG_BASE_URL" name="RAG_BASE_URL">
                                        <!-- 隐藏的嵌入API URL字段 -->
                                        <input type="hidden" id="RAG_EMBEDDING_URL" name="RAG_EMBEDDING_URL">
                                        <!-- 隐藏的重排序API URL字段 -->
                                        <input type="hidden" id="RAG_RERANK_URL" name="RAG_RERANK_URL">

                                        <!-- 嵌入模型选择 -->
                                        <div class="mb-3">
                                            <label class="form-label">
                                                <i class="bi bi-cpu me-2"></i>嵌入模型
                                            </label>
                                            <select class="form-select" id="rag_embedding_model_select"
                                                onchange="updateRagEmbeddingModel(this.value)">
                                                <!-- 动态填充选项 -->
                                            </select>
                                        </div>

                                        <!-- 自定义嵌入模型输入框 -->
                                        <div class="mb-3" id="rag_customEmbeddingInput" style="display: none;">
                                            <label class="form-label">
                                                <i class="bi bi-code-square me-2"></i>自定义嵌入模型名称
                                            </label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="rag_custom_embedding"
                                                    placeholder="your-custom-embedding-model"
                                                    oninput="updateRagCustomEmbedding(this.value)">
                                            </div>
                                        </div>

                                        <!-- 隐藏的嵌入模型字段 -->
                                        <input type="hidden" id="RAG_EMBEDDING_MODEL" name="RAG_EMBEDDING_MODEL">

                                        <!-- 重排序开关 -->
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="RAG_IS_RERANK"
                                                    name="RAG_IS_RERANK"
                                                    onchange="toggleRerankModelSection(this.checked)" data-init="false">
                                                <label class="form-check-label" for="RAG_IS_RERANK">
                                                    启用重排序
                                                </label>
                                            </div>
                                            <div class="form-text">重排序可增强记忆力​，但是回复速度会减慢，请酌情选择</div>
                                        </div>

                                        <!-- 重排序模型选择 -->
                                        <div class="mb-3" id="reranker_model_container" style="display: none;">
                                            <label class="form-label">
                                                <i class="bi bi-sort-alpha-down me-2"></i>重排序模型
                                            </label>
                                            <select class="form-select" id="rag_reranker_model_select"
                                                onchange="updateRagRerankerModel(this.value)">
                                                <!-- 动态填充选项 -->
                                            </select>
                                        </div>

                                        <!-- 自定义重排序模型输入框 -->
                                        <div class="mb-3" id="rag_customRerankerInput" style="display: none;">
                                            <label class="form-label">
                                                <i class="bi bi-code-square me-2"></i>自定义重排序模型名称
                                            </label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="rag_custom_reranker"
                                                    placeholder="your-custom-reranker-model"
                                                    oninput="updateRagCustomReranker(this.value)">
                                            </div>
                                        </div>

                                        <!-- 隐藏的重排序模型字段 -->
                                        <input type="hidden" id="RAG_RERANKER_MODEL" name="RAG_RERANKER_MODEL">

                                        <!-- 检索数量设置 -->
                                        <div class="mb-3">
                                            <label for="RAG_TOP_K" class="form-label">
                                                <i class="bi bi-list-ol me-2"></i>检索数量
                                                <span class="badge bg-primary ms-1" id="RAG_TOP_K_display">5</span>
                                            </label>
                                            <input type="range" class="form-range" id="RAG_TOP_K_slider" min="1"
                                                max="20" step="1" value="5" oninput="updateRagTopK(this.value)">
                                            <input type="hidden" id="RAG_TOP_K" name="RAG_TOP_K" value="5">
                                            <div class="form-text">记忆检索返回的最大记忆条数，建议值：3-8</div>
                                        </div>

                                        <!-- 本地模型是否启用 -->
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="LOCAL_MODEL_ENABLED"
                                                    name="LOCAL_MODEL_ENABLED"
                                                    onchange="toggleLocalModelSection(this.checked)">
                                                <label class="form-check-label" for="LOCAL_MODEL_ENABLED">
                                                    启用本地模型
                                                </label>
                                            </div>
                                            <div class="form-text">启用后请自行下载Hugging Face模型并选择其所在路径作为备用，可在API不可用时保持系统运行
                                            </div>
                                        </div>

                                        <!-- 本地模型相关设置 -->
                                        <div id="local_model_settings" style="display: none;">
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="bi bi-link-45deg me-2"></i>Hugging Face模型
                                                </label>
                                                <div class="d-flex align-items-center mb-2">
                                                    <a href="https://huggingface.co/models?filter=sentence-transformers"
                                                        target="_blank" class="btn btn-outline-primary btn-sm">
                                                        <i class="bi bi-box-arrow-up-right me-1"></i>浏览Hugging Face模型
                                                    </a>
                                                </div>
                                                <input type="text" class="form-control" id="LOCAL_EMBEDDING_MODEL_PATH"
                                                    name="LOCAL_EMBEDDING_MODEL_PATH"
                                                    value="paraphrase-multilingual-MiniLM-L12-v2"
                                                    placeholder="例如: paraphrase-multilingual-MiniLM-L12-v2">
                                                <div class="form-text">输入Hugging Face模型ID或本地模型路径</div>
                                            </div>
                                        </div>

                                        <!-- 硅基流动自动适配设置 -->
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox"
                                                    id="AUTO_ADAPT_SILICONFLOW" name="AUTO_ADAPT_SILICONFLOW" checked>
                                                <label class="form-check-label" for="AUTO_ADAPT_SILICONFLOW">
                                                    硅基流动自动适配
                                                </label>
                                            </div>
                                            <div class="form-text">使用硅基流动API时自动切换到兼容模型</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 保存按钮固定在底部 -->
        <div class="position-fixed bottom-0 start-0 w-100 bg-body p-3 shadow-lg">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <button type="button" class="btn btn-primary btn-lg w-100" id="saveButton">
                            <i class="bi bi-save me-2"></i>保存所有设置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="toast-container">
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body">
                <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                <span class="toast-message"></span>
            </div>
        </div>
    </div>

    <!-- 在 body 标签下添加顶部通知区域 -->
    <div class="position-fixed top-0 start-50 translate-middle-x p-3 notification-container">
        <div id="saveNotification" class="toast align-items-center text-white bg-success border-0" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span id="saveNotificationMessage"></span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="关闭通知"></button>
            </div>
        </div>
    </div>

    <!-- 监听用户列表为空的确认对话框 -->
    <div class="modal fade" id="emptyListenListModal" tabindex="-1" aria-labelledby="emptyListenListModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emptyListenListModalLabel">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>提示
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <p>您未填写监听用户，是否继续保存？</p>
                    <p class="text-muted small">未填写监听用户将导致机器人无法响应任何消息。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">否</button>
                    <button type="button" class="btn btn-secondary" id="confirmSaveBtn">是</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 任务列表模态框 -->
    <div class="modal fade" id="taskListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-list-check me-2"></i>定时任务列表
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <div id="taskListContainer" class="list-group">
                        <!-- 默认显示无任务提示 -->
                        <div class="text-center text-muted p-4">
                            <i class="bi bi-inbox fs-2"></i>
                            <p class="mt-2">暂无定时任务</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加任务模态框 -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTaskModalLabel">
                        <i class="bi bi-plus-circle me-2"></i>添加定时任务
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-key me-2"></i>任务ID
                            </label>
                            <input type="text" class="form-control" id="taskId" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-person me-2"></i>发送对象
                            </label>
                            <select class="form-select" id="taskChatId" required>
                                <!-- 将通过JS动态填充 -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-chat-text me-2"></i>消息内容
                            </label>
                            <textarea class="form-control" id="taskContent" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-calendar3 me-2"></i>定时设置
                            </label>

                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <div class="input-group">
                                        <span class="input-group-text">小时</span>
                                        <input type="number" class="form-control" id="cronHour" min="0" max="23"
                                            step="1" value="9" onchange="updateCronExpression()">
                                    </div>
                                </div>

                                <div class="col-md-6 mb-2">
                                    <div class="input-group">
                                        <span class="input-group-text">分钟</span>
                                        <input type="number" class="form-control" id="cronMinute" min="0" max="59"
                                            step="1" value="0" onchange="updateCronExpression()">
                                    </div>
                                </div>
                            </div>

                            <!-- 添加日程按钮 -->
                            <div class="mt-2 mb-3">
                                <button type="button" class="btn btn-outline-primary w-100" id="scheduleButton"
                                    onclick="showCalendar()">
                                    <i class="bi bi-calendar-date me-2"></i>选择具体日期
                                </button>
                                <div id="selectedDates" class="mt-2 small">
                                    <!-- 这里将显示选择的日期 -->
                                </div>
                            </div>

                            <!-- 隐藏的Cron表达式字段，用于存储完整表达式 -->
                            <input type="hidden" class="form-control" id="cronExpression">

                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                当前设置: <span id="cronDescription">每天 09:00</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加历史配置模态框 -->
    <div class="modal fade" id="historyConfigModal" tabindex="-1" aria-labelledby="historyConfigModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="historyConfigModalLabel">
                        <i class="bi bi-clock-history me-2"></i>历史配置
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="list-group" id="historyConfigList">
                        <!-- 历史配置列表将通过JavaScript动态填充 -->
                        <div class="text-center text-muted p-4">
                            <i class="bi bi-inbox fs-2"></i>
                            <p class="mt-2">暂无历史配置记录</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 日历选择器模态框 -->
    <div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="calendarModalLabel">
                        <i class="bi bi-calendar3 me-2"></i>选择执行日期
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button class="btn btn-sm btn-outline-secondary" id="prevMonth">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <h5 class="mb-0" id="currentMonth">2023年12月</h5>
                        <button class="btn btn-sm btn-outline-secondary" id="nextMonth">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>

                    <div class="mb-3">
                        <div class="btn-group-sm w-100 d-flex" role="group">
                            <button type="button" class="btn btn-outline-primary flex-fill"
                                onclick="selectAllDays()">全选</button>
                            <button type="button" class="btn btn-outline-primary flex-fill"
                                onclick="selectWeekdays()">工作日</button>
                            <button type="button" class="btn btn-outline-primary flex-fill"
                                onclick="selectWeekends()">周末</button>
                            <button type="button" class="btn btn-outline-danger flex-fill"
                                onclick="clearSelection()">清除</button>
                        </div>
                    </div>

                    <div class="calendar-container">
                        <div class="calendar-header d-flex">
                            <div class="calendar-cell">日</div>
                            <div class="calendar-cell">一</div>
                            <div class="calendar-cell">二</div>
                            <div class="calendar-cell">三</div>
                            <div class="calendar-cell">四</div>
                            <div class="calendar-cell">五</div>
                            <div class="calendar-cell">六</div>
                        </div>
                        <div class="calendar-body" id="calendarBody">
                            <!-- 日历JS动态生成 -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmDateSelection()">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 在页面中添加隐藏的配置数据 -->
    <script id="config_data" type="application/json">
        {{ config_json|safe }}
    </script>

    <script>
        // 护眼模式切换
        function toggleDarkMode ()
        {
            document.body.setAttribute( 'data-bs-theme',
                document.body.getAttribute( 'data-bs-theme' ) === 'dark' ? 'light' : 'dark' );
        }

        // 初始化工具提示
        var tooltipTriggerList = [].slice.call( document.querySelectorAll( '[data-bs-toggle="tooltip"]' ) )
        var tooltipList = tooltipTriggerList.map( function ( tooltipTriggerEl )
        {
            return new bootstrap.Tooltip( tooltipTriggerEl )
        } )

        // 页面加载时初始化所有配置数据
        document.addEventListener( 'DOMContentLoaded', function ()
        {
            // 立即初始化RAG设置（使用默认值）
            initRagSettings();

            // 获取最新的配置数据
            fetch( '/get_all_configs' )
                .then( response => response.json() )
                .then( data =>
                {
                    if ( data.status === 'success' )
                    {
                        console.log( "配置数据已获取，开始更新UI..." );
                        // 更新所有配置项
                        updateAllConfigs( data.configs );

                        // 更新任务列表
                        const tasksInput = document.getElementById( 'TASKS' );
                        if ( tasksInput && data.tasks )
                        {
                            tasksInput.value = JSON.stringify( data.tasks );
                            updateTaskList();
                        }

                        // 再次初始化RAG设置，确保UI反映最新配置
                        initRagSettings();
                        console.log( "配置数据加载完成，UI已更新" );
                    } else
                    {
                        console.error( '获取配置数据失败:', data.message );
                    }
                } )
                .catch( error =>
                {
                    console.error( '获取配置数据请求失败:', error );
                    // 如果请求失败，使用页面加载时的初始数据
                    const tasksInput = document.getElementById( 'TASKS' );
                    if ( tasksInput )
                    {
                        updateTaskList();
                    }
                } );

            // 确保角色设定选择框的变更能够正确保存
            const avatarDirSelect = document.getElementById( 'AVATAR_DIR' );
            if ( avatarDirSelect )
            {
                avatarDirSelect.addEventListener( 'change', function ()
                {
                    console.log( '角色设定已更改为:', this.value );
                } );
            }

            // 获取保存按钮
            const saveButton = document.getElementById( 'saveButton' );

            // 添加点击事件监听器
            saveButton.addEventListener( 'click', function ()
            {
                const mainForm = document.getElementById( 'configForm' );
                const otherForm = document.getElementById( 'otherConfigForm' );
                const globalConfig = {};

                // 获取所有表单数据
                const formData = new FormData( mainForm );

                // 处理表单数据
                for ( let [ key, value ] of formData.entries() )
                {
                    processFormValue( globalConfig, key, value );
                }

                if ( otherForm )
                {
                    const otherFormData = new FormData( otherForm );
                    for ( let [ key, value ] of otherFormData.entries() )
                    {
                        processFormValue( globalConfig, key, value );
                    }
                }

                // 处理RAG配置
                // 确保所有RAG配置项都被包含在保存中
                globalConfig[ 'RAG_API_KEY' ] = document.getElementById( 'RAG_API_KEY' ).value;
                globalConfig[ 'RAG_BASE_URL' ] = document.getElementById( 'RAG_BASE_URL' ).value;
                globalConfig[ 'RAG_EMBEDDING_MODEL' ] = document.getElementById( 'RAG_EMBEDDING_MODEL' ).value;
                globalConfig[ 'RAG_IS_RERANK' ] = document.getElementById( 'RAG_IS_RERANK' ).checked;
                globalConfig[ 'RAG_RERANKER_MODEL' ] = document.getElementById( 'RAG_RERANKER_MODEL' ).value;
                globalConfig[ 'RAG_TOP_K' ] = parseInt( document.getElementById( 'RAG_TOP_K' ).value, 10 );
                globalConfig[ 'LOCAL_MODEL_ENABLED' ] = document.getElementById( 'LOCAL_MODEL_ENABLED' ).checked;
                globalConfig[ 'LOCAL_EMBEDDING_MODEL_PATH' ] = document.getElementById( 'LOCAL_EMBEDDING_MODEL_PATH' ).value;
                globalConfig[ 'AUTO_ADAPT_SILICONFLOW' ] = document.getElementById( 'AUTO_ADAPT_SILICONFLOW' ).checked;

                // 特别处理任务数据 - 确保直接从隐藏字段获取
                const tasksInput = document.getElementById( 'TASKS' );
                if ( tasksInput )
                {
                    try
                    {
                        const tasksValue = tasksInput.value;
                        if ( tasksValue )
                        {
                            // 解析为JSON对象并添加到配置中
                            globalConfig[ 'TASKS' ] = JSON.parse( tasksValue );
                        }
                    } catch ( e )
                    {
                        // 出错时使用空数组
                        globalConfig[ 'TASKS' ] = [];
                    }
                }

                // 特别检查温度值
                const temperatureSlider = document.getElementById( 'TEMPERATURE_slider' );
                const temperatureInput = document.getElementById( 'TEMPERATURE' );
                if ( temperatureSlider && temperatureInput )
                {
                    const tempValue = parseFloat( temperatureSlider.value );
                    if ( !isNaN( tempValue ) )
                    {
                        globalConfig[ 'TEMPERATURE' ] = tempValue;
                    }
                }

                // 检查页面上是否有用户列表元素
                const userListElement = document.getElementById( 'selected_users_LISTEN_LIST' );
                const hasUsers = userListElement && userListElement.querySelectorAll( '.list-group-item' ).length > 0;

                // 根据是否有用户决定是否显示确认对话框
                if ( !hasUsers )
                {
                    // 创建确认对话框
                    const confirmDialog = new bootstrap.Modal( document.getElementById( 'emptyListenListModal' ) );
                    confirmDialog.show();

                    // 设置确认按钮的事件
                    document.getElementById( 'confirmSaveBtn' ).onclick = function ()
                    {
                        confirmDialog.hide();
                        saveConfig( globalConfig );
                    };
                } else
                {
                    // 直接保存配置
                    saveConfig( globalConfig );
                }
            } );

            // 初始化背景
            fetch( '/get_background' )
                .then( response => response.json() )
                .then( data =>
                {
                    if ( data.status === 'success' && data.path )
                    {
                        document.body.style.backgroundImage = `url('${ data.path }')`;
                    }
                } )
                .catch( error => console.error( 'Error:', error ) );

            // 初始化安静时间设置
            initQuietTimeSettings();

            // 更新历史配置列表
            updateHistoryConfigList();

            // 为历史配置模态框添加显示事件
            document.getElementById( 'historyConfigModal' ).addEventListener( 'show.bs.modal', function ()
            {
                updateHistoryConfigList();
            } );

            // 确保布尔值配置正确初始化
            setTimeout( function ()
            {
                ensureBooleanConfig( 'RAG_IS_RERANK' );
                ensureBooleanConfig( 'LOCAL_MODEL_ENABLED' );
                ensureBooleanConfig( 'AUTO_ADAPT_SILICONFLOW' );
            }, 500 );
        } );

        // 更新所有配置项的函数
        function updateAllConfigs ( configs )
        {
            // 保存RAG相关的隐藏值，供后续使用
            let ragBaseUrl = '';
            let ragEmbeddingUrl = '';
            let ragRerankUrl = '';
            let ragEmbeddingModel = '';
            let ragRerankerModel = '';
            let isRerankEnabled = false;
            let localModelEnabled = false;
            let localModelPath = '';

            // 提取当前值
            const baseUrlElement = document.getElementById( 'RAG_BASE_URL' );
            if ( baseUrlElement ) ragBaseUrl = baseUrlElement.value;

            const embeddingUrlElement = document.getElementById( 'RAG_EMBEDDING_URL' );
            if ( embeddingUrlElement ) ragEmbeddingUrl = embeddingUrlElement.value;

            const rerankUrlElement = document.getElementById( 'RAG_RERANK_URL' );
            if ( rerankUrlElement ) ragRerankUrl = rerankUrlElement.value;

            const embeddingModelElement = document.getElementById( 'RAG_EMBEDDING_MODEL' );
            if ( embeddingModelElement ) ragEmbeddingModel = embeddingModelElement.value;

            const rerankerModelElement = document.getElementById( 'RAG_RERANKER_MODEL' );
            if ( rerankerModelElement ) ragRerankerModel = rerankerModelElement.value;

            const isRerankElement = document.getElementById( 'RAG_IS_RERANK' );
            if ( isRerankElement ) isRerankEnabled = isRerankElement.checked;

            const localModelEnabledElement = document.getElementById( 'LOCAL_MODEL_ENABLED' );
            if ( localModelEnabledElement ) localModelEnabled = localModelEnabledElement.checked;

            const localModelPathElement = document.getElementById( 'LOCAL_EMBEDDING_MODEL_PATH' );
            if ( localModelPathElement ) localModelPath = localModelPathElement.value;

            console.log( "更新前RAG配置:", {
                baseUrl: ragBaseUrl,
                embeddingUrl: ragEmbeddingUrl,
                rerankUrl: ragRerankUrl,
                embeddingModel: ragEmbeddingModel,
                rerankerModel: ragRerankerModel,
                isRerank: isRerankEnabled,
                localModelEnabled: localModelEnabled,
                localModelPath: localModelPath
            } );

            // 遍历所有配置组和配置项
            for ( const groupKey in configs )
            {
                const group = configs[ groupKey ];
                for ( const configKey in group )
                {
                    const configItem = group[ configKey ];
                    const element = document.getElementById( configKey );
                    if ( element )
                    {
                        // 特殊处理可能是对象的值
                        let value = configItem.value;
                        if ( typeof value === 'object' && value !== null && 'value' in value )
                        {
                            value = value.value;
                        }

                        // 根据元素类型设置值
                        if ( element.type === 'checkbox' )
                        {
                            // 对于RAG_IS_RERANK，我们应该保持用户设置的值而不是重置它
                            if ( configKey === 'RAG_IS_RERANK' )
                            {
                                // 从配置中读取正确的值
                                if ( configs[ 'RAG设置' ] && configs[ 'RAG设置' ][ 'RAG_IS_RERANK' ] )
                                {
                                    const configValue = configs[ 'RAG设置' ][ 'RAG_IS_RERANK' ].value;
                                    // 只有当配置值与当前界面值不同时才更新
                                    if ( element.checked !== configValue )
                                    {
                                        console.log( `更新RAG_IS_RERANK从${ element.checked }到配置中的${ configValue }` );
                                        element.checked = configValue;
                                        // 立即触发重排序部分显示/隐藏
                                        toggleRerankModelSection( configValue );
                                    }
                                }
                            } else
                            {
                                element.checked = value;
                            }
                        } else if ( element.tagName === 'SELECT' )
                        {
                            element.value = value;
                        } else
                        {
                            element.value = value;
                        }

                        // 特殊处理RAG配置
                        if ( configKey === 'RAG_BASE_URL' && ragBaseUrl )
                        {
                            element.value = ragBaseUrl;
                        } else if ( configKey === 'RAG_EMBEDDING_MODEL' && ragEmbeddingModel )
                        {
                            element.value = ragEmbeddingModel;
                        } else if ( configKey === 'RAG_RERANKER_MODEL' && ragRerankerModel )
                        {
                            element.value = ragRerankerModel;
                        } else if ( configKey === 'RAG_IS_RERANK' )
                        {
                            // 这里已通过上面的代码处理
                        } else if ( configKey === 'LOCAL_MODEL_ENABLED' )
                        {
                            element.checked = localModelEnabled;
                        } else if ( configKey === 'LOCAL_EMBEDDING_MODEL_PATH' && localModelPath )
                        {
                            element.value = localModelPath;
                        }
                    }
                }
            }

            // 恢复用户的URL配置
            if ( ragBaseUrl )
            {
                document.getElementById( 'RAG_BASE_URL' ).value = ragBaseUrl;
            }
            if ( ragEmbeddingUrl )
            {
                document.getElementById( 'RAG_EMBEDDING_URL' ).value = ragEmbeddingUrl;
            }
            if ( ragRerankUrl )
            {
                document.getElementById( 'RAG_RERANK_URL' ).value = ragRerankUrl;
            }

            // 最后的处理：确保布尔值正确设置并显示
            setTimeout( function ()
            {
                console.log( "最终确认布尔值设置..." );
                // 读取配置中的值，并再次强制同步界面状态
                let configIsRerank = false;
                if ( configs[ 'RAG设置' ] && configs[ 'RAG设置' ][ 'RAG_IS_RERANK' ] )
                {
                    configIsRerank = configs[ 'RAG设置' ][ 'RAG_IS_RERANK' ].value;
                    // 确保是布尔类型
                    if ( typeof configIsRerank === 'string' )
                    {
                        configIsRerank = configIsRerank.toLowerCase() === 'true';
                    }
                    configIsRerank = Boolean( configIsRerank );
                }

                const ragIsRerankElement = document.getElementById( 'RAG_IS_RERANK' );
                if ( ragIsRerankElement )
                {
                    const currentValue = ragIsRerankElement.checked;
                    console.log( `最终确认RAG_IS_RERANK: 当前值=${ currentValue }, 配置值=${ configIsRerank }` );

                    // 只有当当前UI值和配置值不同，且不是用户刚保存的值时才更新
                    // 如果是用户刚刚保存的值，应该保持用户的选择
                    const isRecentUserSave = ( currentState && typeof currentState.ragIsRerank !== 'undefined' );

                    if ( isRecentUserSave )
                    {
                        console.log( `保持用户最近保存的重排序开关值: ${ currentState.ragIsRerank }` );
                        // 使用用户最近保存的值
                        ragIsRerankElement.checked = currentState.ragIsRerank;
                        toggleRerankModelSection( currentState.ragIsRerank );
                    } else if ( currentValue !== configIsRerank )
                    {
                        // 不是最近保存的值，且与配置不同，使用配置值
                        console.log( `更新重排序开关状态从${ currentValue }到配置值${ configIsRerank }` );
                        ragIsRerankElement.checked = configIsRerank;
                        toggleRerankModelSection( configIsRerank );
                    } else
                    {
                        // 值相同，但仍然触发UI更新以确保一致性
                        console.log( `重排序开关状态与配置一致(${ configIsRerank })，确保UI正确显示` );
                        toggleRerankModelSection( configIsRerank );
                    }
                }

                // 处理其他布尔值配置
                ensureBooleanConfig( 'LOCAL_MODEL_ENABLED' );
                ensureBooleanConfig( 'AUTO_ADAPT_SILICONFLOW' );
            }, 200 );

            // 记录更新后的值
            console.log( "更新后RAG配置:", {
                baseUrl: document.getElementById( 'RAG_BASE_URL' ).value,
                embeddingModel: document.getElementById( 'RAG_EMBEDDING_MODEL' ).value,
                rerankerModel: document.getElementById( 'RAG_RERANKER_MODEL' ).value,
                isRerank: document.getElementById( 'RAG_IS_RERANK' ).checked
            } );
        }

        // 修改保存配置到cookie的函数
        function saveConfigToCookie ( config )
        {
            // 提取需要保存的关键配置
            const keyConfigs = {
                timestamp: new Date().toISOString(),
                LISTEN_LIST: config.LISTEN_LIST || [],
                DEEPSEEK_API_KEY: config.DEEPSEEK_API_KEY || '',
                DEEPSEEK_BASE_URL: config.DEEPSEEK_BASE_URL || '',
                MODEL: config.MODEL || '',
                MOONSHOT_API_KEY: config.MOONSHOT_API_KEY || '',
                TEMPERATURE: config.TEMPERATURE || 1.0,
                MAX_TOKEN: config.MAX_TOKEN || 2000,
                MOONSHOT_BASE_URL: config.MOONSHOT_BASE_URL || '',
                MOONSHOT_TEMPERATURE: config.MOONSHOT_TEMPERATURE || 0.7,

                MAX_GROUPS: config.MAX_GROUPS || 30,
                AVATAR_DIR: config.AVATAR_DIR || '',

                AUTO_MESSAGE: config.AUTO_MESSAGE || '',
                QUIET_TIME_START: config.QUIET_TIME_START || '',
                QUIET_TIME_END: config.QUIET_TIME_END || ''
            };

            // 检查是否有有效数据
            const hasValidData =
                ( keyConfigs.LISTEN_LIST && keyConfigs.LISTEN_LIST.length > 0 ) ||
                keyConfigs.DEEPSEEK_API_KEY ||
                keyConfigs.DEEPSEEK_BASE_URL ||
                keyConfigs.MODEL;

            if ( !hasValidData )
            {
                console.log( '没有有效数据，不保存到cookie' );
                return;
            }

            // 获取现有的历史配置
            let historyConfigs = getCookieConfigs();

            // 检查是否已存在相同配置 - 仅检查关键字段
            const isDuplicate = historyConfigs.some( item =>
                JSON.stringify( [
                    item.LISTEN_LIST,
                    item.DEEPSEEK_API_KEY,
                    item.DEEPSEEK_BASE_URL,
                    item.MODEL
                ] ) ===
                JSON.stringify( [
                    keyConfigs.LISTEN_LIST,
                    keyConfigs.DEEPSEEK_API_KEY,
                    keyConfigs.DEEPSEEK_BASE_URL,
                    keyConfigs.MODEL
                ] )
            );

            if ( isDuplicate )
            {
                console.log( '配置已存在，不重复保存' );
                return;
            }

            // 限制历史记录数量为10条
            if ( historyConfigs.length >= 10 )
            {
                historyConfigs.pop(); // 移除最旧的配置
            }

            // 添加新配置到历史记录开头
            historyConfigs.unshift( keyConfigs );

            // 保存到cookie，有效期30天
            const expiryDate = new Date();
            expiryDate.setDate( expiryDate.getDate() + 30 );

            // 使用localStorage替代cookie以便存储更多数据
            try
            {
                localStorage.setItem( 'historyConfigs', JSON.stringify( historyConfigs ) );
                console.log( '历史配置已保存到localStorage' );
            } catch ( e )
            {
                // 如果localStorage不可用，回退到cookie（可能会受大小限制）
                console.error( '保存到localStorage失败，尝试使用cookie:', e );
                document.cookie = `historyConfigs=${ JSON.stringify( historyConfigs ) };expires=${ expiryDate.toUTCString() };path=/`;
            }

            // 更新历史配置列表显示
            updateHistoryConfigList();
        }

        // 从cookie或localStorage获取历史配置
        function getCookieConfigs ()
        {
            // 首先尝试从localStorage获取
            const localStorageData = localStorage.getItem( 'historyConfigs' );
            if ( localStorageData )
            {
                try
                {
                    return JSON.parse( localStorageData );
                } catch ( e )
                {
                    console.error( '解析localStorage历史配置失败:', e );
                    // 如果解析失败，继续尝试cookie
                }
            }

            // 从cookie获取
            const cookieValue = document.cookie
                .split( '; ' )
                .find( row => row.startsWith( 'historyConfigs=' ) );

            if ( cookieValue )
            {
                try
                {
                    return JSON.parse( cookieValue.split( '=' )[ 1 ] );
                } catch ( e )
                {
                    console.error( '解析cookie历史配置失败:', e );
                    return [];
                }
            }

            return [];
        }

        // 修改历史配置列表显示函数，添加更多信息显示
        function updateHistoryConfigList ()
        {
            const historyConfigs = getCookieConfigs();
            const container = document.getElementById( 'historyConfigList' );

            if ( !container ) return;

            if ( historyConfigs.length === 0 )
            {
                container.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="bi bi-inbox fs-2"></i>
                        <p class="mt-2">暂无历史配置记录</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = historyConfigs.map( ( config, index ) =>
            {
                const date = new Date( config.timestamp );
                const formattedDate = `${ date.getFullYear() }-${ ( date.getMonth() + 1 ).toString().padStart( 2, '0' ) }-${ date.getDate().toString().padStart( 2, '0' ) } ${ date.getHours().toString().padStart( 2, '0' ) }:${ date.getMinutes().toString().padStart( 2, '0' ) }`;

                // 格式化监听用户列表，确保它是数组
                let listenList = config.LISTEN_LIST || [];
                if ( !Array.isArray( listenList ) )
                {
                    try
                    {
                        if ( typeof listenList === 'string' )
                        {
                            listenList = listenList.split( ',' ).filter( item => item.trim() );
                        } else
                        {
                            listenList = [];
                        }
                    } catch ( e )
                    {
                        console.error( '格式化监听用户列表失败:', e );
                        listenList = [];
                    }
                }

                return `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="me-auto" style="width: 75%;">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge bg-primary me-2">配置 #${ index + 1 }</span>
                                    <small class="text-muted">${ formattedDate }</small>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <div class="mb-1"><strong>监听用户:</strong> ${ listenList.join( ', ' ) || '无' }</div>
                                        <div class="mb-1"><strong>AI模型:</strong> ${ config.MODEL || '未设置' }</div>
                                        <div class="mb-1"><strong>温度:</strong> ${ config.TEMPERATURE || '默认' }</div>
                                        <div class="mb-1"><strong>角色设定:</strong> ${ config.AVATAR_DIR || '默认' }</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-1"><strong>API URL:</strong> ${ config.DEEPSEEK_BASE_URL ? config.DEEPSEEK_BASE_URL.substring( 0, 25 ) + '...' : '未设置' }</div>
                                        <div class="mb-1"><strong>API密钥:</strong> ${ config.DEEPSEEK_API_KEY ? '******' + config.DEEPSEEK_API_KEY.substring( config.DEEPSEEK_API_KEY.length - 4 ) : '未设置' }</div>
                                        <div class="mb-1"><strong>Moonshot:</strong> ${ config.MOONSHOT_API_KEY ? '已设置' : '未设置' }</div>
                                        <div class="mb-1"><strong>最大Token:</strong> ${ config.MAX_TOKEN || '默认' }</div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-danger btn-sm me-2" onclick="deleteHistoryConfig(${ index })">
                                    <i class="bi bi-trash me-1"></i>删除
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="applyHistoryConfig(${ index })">
                                    <i class="bi bi-arrow-clockwise me-1"></i>应用
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } ).join( '' );
        }

        // 删除历史配置的函数也需要更新
        function deleteHistoryConfig ( index )
        {
            // 获取历史配置
            let historyConfigs = getCookieConfigs();

            // 检查索引是否有效
            if ( index >= 0 && index < historyConfigs.length )
            {
                // 删除指定索引的配置
                historyConfigs.splice( index, 1 );

                // 更新cookie
                const expiryDate = new Date();
                expiryDate.setDate( expiryDate.getDate() + 30 );

                // 优先使用localStorage
                try
                {
                    localStorage.setItem( 'historyConfigs', JSON.stringify( historyConfigs ) );
                } catch ( e )
                {
                    // 如果localStorage不可用，回退到cookie
                    document.cookie = `historyConfigs=${ JSON.stringify( historyConfigs ) };expires=${ expiryDate.toUTCString() };path=/`;
                }

                // 更新界面
                updateHistoryConfigList();

                // 显示提示消息
                showSaveNotification( '历史配置已删除', 'success' );
            }
        }

        // 修改应用历史配置函数
        function applyHistoryConfig ( index )
        {
            const historyConfigs = getCookieConfigs();
            if ( index >= historyConfigs.length ) return;

            const historyConfig = historyConfigs[ index ];
            console.log( "应用历史配置:", historyConfig );

            // 应用监听用户列表
            if ( historyConfig.LISTEN_LIST )
            {
                let userList = historyConfig.LISTEN_LIST;
                // 确保用户列表是数组
                if ( !Array.isArray( userList ) && typeof userList === 'string' )
                {
                    userList = userList.split( ',' ).map( item => item.trim() ).filter( item => item );
                }

                if ( Array.isArray( userList ) )
                {
                    const userListElement = document.getElementById( 'selected_users_LISTEN_LIST' );
                    const listenListInput = document.getElementById( 'LISTEN_LIST' );

                    if ( userListElement && listenListInput )
                    {
                        // 清空现有用户
                        userListElement.innerHTML = '';

                        // 添加历史用户
                        userList.forEach( user =>
                        {
                            if ( user )
                            {
                                const userDiv = document.createElement( 'div' );
                                userDiv.className = 'list-group-item d-flex justify-content-between align-items-center';
                                userDiv.innerHTML = `
                                    ${ user }
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeUser('LISTEN_LIST', '${ user }')">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                `;
                                userListElement.appendChild( userDiv );
                            }
                        } );

                        // 更新隐藏输入框
                        listenListInput.value = userList.join( ',' );
                    }
                }
            }

            // 应用API密钥
            if ( historyConfig.DEEPSEEK_API_KEY )
            {
                const apiKeyInput = document.getElementById( 'DEEPSEEK_API_KEY' ) ||
                    document.querySelector( 'input[name="DEEPSEEK_API_KEY"]' );
                if ( apiKeyInput )
                {
                    apiKeyInput.value = historyConfig.DEEPSEEK_API_KEY;
                }
            }

            // 应用API Base URL
            if ( historyConfig.DEEPSEEK_BASE_URL )
            {
                const baseUrlInput = document.getElementById( 'DEEPSEEK_BASE_URL' );
                const apiProviderSelect = document.getElementById( 'api_provider_select' );
                const customApiInput = document.getElementById( 'customApiInput' );

                if ( baseUrlInput )
                {
                    baseUrlInput.value = historyConfig.DEEPSEEK_BASE_URL;

                    if ( apiProviderSelect )
                    {
                        // 检查是否是预定义的URL
                        const matchingOption = Array.from( apiProviderSelect.options ).find( opt =>
                        {
                            return opt.dataset.url === historyConfig.DEEPSEEK_BASE_URL;
                        } );

                        if ( matchingOption )
                        {
                            apiProviderSelect.value = matchingOption.value;
                            if ( customApiInput )
                            {
                                customApiInput.style.display = 'none';
                            }
                        } else
                        {
                            apiProviderSelect.value = 'custom';
                            if ( customApiInput )
                            {
                                customApiInput.style.display = 'block';
                                const input = customApiInput.querySelector( 'input' );
                                if ( input )
                                {
                                    input.value = historyConfig.DEEPSEEK_BASE_URL;
                                }
                            }
                        }
                    }
                }
            }

            // 应用模型
            if ( historyConfig.MODEL )
            {
                const modelInput = document.getElementById( 'MODEL' );
                const modelSelect = document.getElementById( 'model_select' );
                if ( modelInput )
                {
                    modelInput.value = historyConfig.MODEL;
                    if ( modelSelect )
                    {
                        // 检查是否是预定义的模型
                        if ( Array.from( modelSelect.options ).some( opt => opt.value === historyConfig.MODEL ) )
                        {
                            modelSelect.value = historyConfig.MODEL;
                            const customModelInput = document.getElementById( 'customModelInput' );
                            if ( customModelInput )
                            {
                                customModelInput.style.display = 'none';
                            }
                        } else
                        {
                            // 如果是自定义模型
                            modelSelect.value = 'custom';
                            const customModelInput = document.getElementById( 'customModelInput' );
                            if ( customModelInput )
                            {
                                customModelInput.style.display = 'block';
                                const input = customModelInput.querySelector( 'input' );
                                if ( input ) input.value = historyConfig.MODEL;
                            }
                        }
                    }
                }
            }

            // 应用温度滑块
            if ( historyConfig.TEMPERATURE !== undefined )
            {
                const temperatureInput = document.getElementById( 'TEMPERATURE' );
                const temperatureSlider = document.getElementById( 'TEMPERATURE_slider' );
                const tempDisplay = document.getElementById( 'TEMPERATURE_display' );

                if ( temperatureInput ) temperatureInput.value = historyConfig.TEMPERATURE;
                if ( temperatureSlider )
                {
                    temperatureSlider.value = historyConfig.TEMPERATURE;
                    // 更新显示值
                    if ( tempDisplay ) tempDisplay.textContent = parseFloat( historyConfig.TEMPERATURE ).toFixed( 1 );
                }
            }

            // 应用最大Token
            if ( historyConfig.MAX_TOKEN !== undefined )
            {
                const maxTokenInput = document.getElementById( 'MAX_TOKEN' );
                if ( maxTokenInput ) maxTokenInput.value = historyConfig.MAX_TOKEN;
            }

            // 应用Moonshot API配置
            if ( historyConfig.MOONSHOT_API_KEY )
            {
                const moonshotApiKeyInput = document.getElementById( 'MOONSHOT_API_KEY' );
                if ( moonshotApiKeyInput ) moonshotApiKeyInput.value = historyConfig.MOONSHOT_API_KEY;
            }

            if ( historyConfig.MOONSHOT_BASE_URL )
            {
                const moonshotBaseUrlInput = document.getElementById( 'MOONSHOT_BASE_URL' );
                if ( moonshotBaseUrlInput ) moonshotBaseUrlInput.value = historyConfig.MOONSHOT_BASE_URL;
            }

            if ( historyConfig.MOONSHOT_TEMPERATURE !== undefined )
            {
                const moonshotTempInput = document.getElementById( 'MOONSHOT_TEMPERATURE' );
                if ( moonshotTempInput ) moonshotTempInput.value = historyConfig.MOONSHOT_TEMPERATURE;
            }

            // 应用角色设定
            if ( historyConfig.AVATAR_DIR )
            {
                const avatarDirSelect = document.getElementById( 'AVATAR_DIR' );
                if ( avatarDirSelect ) avatarDirSelect.value = historyConfig.AVATAR_DIR;
            }



            // 应用自动消息配置
            if ( historyConfig.AUTO_MESSAGE )
            {
                const autoMessageInput = document.getElementById( 'AUTO_MESSAGE' );
                if ( autoMessageInput ) autoMessageInput.value = historyConfig.AUTO_MESSAGE;
            }

            // 应用安静时间配置
            if ( historyConfig.QUIET_TIME_START )
            {
                const quietTimeStartInput = document.getElementById( 'QUIET_TIME_START' );
                if ( quietTimeStartInput ) quietTimeStartInput.value = historyConfig.QUIET_TIME_START;
            }

            if ( historyConfig.QUIET_TIME_END )
            {
                const quietTimeEndInput = document.getElementById( 'QUIET_TIME_END' );
                if ( quietTimeEndInput ) quietTimeEndInput.value = historyConfig.QUIET_TIME_END;
            }



            // 应用MAX_GROUPS配置
            if ( historyConfig.MAX_GROUPS !== undefined )
            {
                const maxGroupsInput = document.getElementById( 'MAX_GROUPS' );
                if ( maxGroupsInput ) maxGroupsInput.value = historyConfig.MAX_GROUPS;
            }

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance( document.getElementById( 'historyConfigModal' ) );
            if ( modal ) modal.hide();

            // 更新任务对话框中的发送对象选项
            updateTaskChatIdOptions();

            // 显示提示
            showSaveNotification( '已应用历史配置，请点击保存按钮保存更改', 'success' );
        }

        // 定义全局变量来保存用户的当前选择状态
        let currentState = null;

        // 修改保存配置的函数，添加对不同API URL路径的处理
        function saveConfig ( globalConfig )
        {
            // 记录当前选择的配置，用于保存后恢复
            currentState = {
                ragApiProvider: document.getElementById( 'rag_api_provider_select' ).value,
                ragBaseUrl: document.getElementById( 'RAG_BASE_URL' ).value,
                ragEmbeddingUrl: document.getElementById( 'RAG_EMBEDDING_URL' ).value,
                ragRerankUrl: document.getElementById( 'RAG_RERANK_URL' ).value,
                ragEmbeddingModel: document.getElementById( 'RAG_EMBEDDING_MODEL' ).value,
                ragEmbeddingModelSelect: document.getElementById( 'rag_embedding_model_select' ).value,
                ragRerankerModel: document.getElementById( 'RAG_RERANKER_MODEL' ).value,
                ragRerankerModelSelect: document.getElementById( 'rag_reranker_model_select' ).value,
                ragIsRerank: document.getElementById( 'RAG_IS_RERANK' ).checked,
                localModelEnabled: document.getElementById( 'LOCAL_MODEL_ENABLED' ).checked,
                localModelPath: document.getElementById( 'LOCAL_EMBEDDING_MODEL_PATH' ).value,
                saveTime: new Date().getTime() // 添加保存时间戳
            };

            console.log( "保存前状态:", currentState );
            console.log( "保存前RAG_IS_RERANK状态:", globalConfig[ 'RAG_IS_RERANK' ] );

            // 确保角色设定值被正确处理
            const avatarDirSelect = document.getElementById( 'AVATAR_DIR' );
            if ( avatarDirSelect && avatarDirSelect.value )
            {
                globalConfig[ 'AVATAR_DIR' ] = avatarDirSelect.value;
                console.log( '保存角色设定:', globalConfig[ 'AVATAR_DIR' ] );
            }

            // 确保隐藏字段的值被包含在配置中
            const embeddingUrl = document.getElementById( 'RAG_EMBEDDING_URL' ).value;
            if ( embeddingUrl )
            {
                globalConfig[ 'RAG_EMBEDDING_URL' ] = embeddingUrl;
            }

            const rerankUrl = document.getElementById( 'RAG_RERANK_URL' ).value;
            if ( rerankUrl )
            {
                globalConfig[ 'RAG_RERANK_URL' ] = rerankUrl;
            }

            // 特别处理监听用户列表
            const listenList = document.getElementById( 'LISTEN_LIST' );
            if ( listenList )
            {
                // 获取隐藏input中的值
                const listenListValue = listenList.value;
                // 如果有值，确保它被包含在配置中
                if ( listenListValue )
                {
                    globalConfig[ 'LISTEN_LIST' ] = listenListValue;
                    console.log( "保存监听用户列表:", listenListValue );
                } else
                {
                    // 如果隐藏input为空，但页面上有用户，则从页面收集用户列表
                    const userListElement = document.getElementById( 'selected_users_LISTEN_LIST' );
                    if ( userListElement )
                    {
                        const users = [];
                        const userElements = userListElement.querySelectorAll( '.list-group-item' );
                        userElements.forEach( element =>
                        {
                            // 去除按钮文本，只获取用户名
                            const userName = element.textContent.trim();
                            if ( userName ) users.push( userName );
                        } );
                        if ( users.length > 0 )
                        {
                            globalConfig[ 'LISTEN_LIST' ] = users.join( ',' );
                            console.log( "从页面元素收集监听用户列表:", globalConfig[ 'LISTEN_LIST' ] );
                        }
                    }
                }
            }

            // 重排序值可能是布尔值或字符串，确保以正确的布尔值发送
            globalConfig[ 'RAG_IS_RERANK' ] = document.getElementById( 'RAG_IS_RERANK' ).checked;
            console.log( "发送保存请求前的RAG_IS_RERANK值:", globalConfig[ 'RAG_IS_RERANK' ] );

            // 保存到localStorage，确保页面刷新后也能正确读取
            try
            {
                // 保存RAG配置到localStorage
                const ragConfig = {
                    baseUrl: document.getElementById( 'RAG_BASE_URL' ).value,
                    embeddingModel: document.getElementById( 'RAG_EMBEDDING_MODEL' ).value,
                    rerankerModel: document.getElementById( 'RAG_RERANKER_MODEL' ).value,
                    isRerank: document.getElementById( 'RAG_IS_RERANK' ).checked,
                    savedTime: new Date().getTime()
                };
                localStorage.setItem( 'ragConfig', JSON.stringify( ragConfig ) );
                console.log( "已保存当前RAG配置到localStorage:", ragConfig );
            } catch ( e )
            {
                console.error( "保存RAG配置到localStorage失败:", e );
            }

            // 保存配置
            const formData = new FormData();

            // 处理表单数据
            for ( let key in globalConfig )
            {
                if ( key === 'TASKS' )
                {
                    formData.append( key, JSON.stringify( globalConfig[ key ] ) );
                } else if ( key === 'LISTEN_LIST' )
                {
                    formData.append( key, globalConfig[ key ] );
                } else
                {
                    formData.append( key, globalConfig[ key ] );
                }
            }

            // 发送保存请求
            fetch( '/save', {
                method: 'POST',
                body: formData
            } )
                .then( response => response.json() )
                .then( data =>
                {
                    if ( data.status === 'success' )
                    {
                        // 保存配置到cookie
                        saveConfigToCookie( globalConfig );

                        // 显示成功消息
                        showSaveNotification( data.message || '配置已成功保存' );

                        // 延迟一段时间后刷新UI
                        setTimeout( () =>
                        {
                            // 直接强制恢复用户设置的重排序开关状态
                            const isRerankCheckbox = document.getElementById( 'RAG_IS_RERANK' );
                            if ( isRerankCheckbox )
                            {
                                isRerankCheckbox.checked = currentState.ragIsRerank;
                                toggleRerankModelSection( currentState.ragIsRerank );
                            }

                            // 保存成功后，直接加载最新配置
                            try
                            {
                                fetch( '/get_config' )
                                    .then( response => response.json() )
                                    .then( configData =>
                                    {
                                        if ( configData.status === 'success' )
                                        {
                                            console.log( "保存成功，获取到最新配置:", configData.config );

                                            // 使用获取到的配置进行更新，特别关注监听用户列表
                                            if ( configData.config && configData.config.LISTEN_LIST !== undefined )
                                            {
                                                // 更新监听用户列表显示
                                                updateListenUserList( configData.config.LISTEN_LIST );
                                            }

                                            // 更新历史配置列表
                                            updateHistoryConfigList();
                                        } else
                                        {
                                            console.error( "获取最新配置失败:", configData.message );
                                        }
                                    } )
                                    .catch( error =>
                                    {
                                        console.error( "获取最新配置出错:", error );
                                    } );
                            } catch ( e )
                            {
                                console.error( "刷新配置时出错:", e );
                            }
                        }, 500 );
                    } else
                    {
                        // 显示错误消息
                        showSaveNotification( data.message || '保存配置失败', 'error' );
                    }
                } )
                .catch( error =>
                {
                    // 显示错误消息
                    console.error( "保存配置时出错:", error );
                    showSaveNotification( '保存失败：' + error, 'error' );
                } );
        }

        // 添加一个新函数来更新监听用户列表显示
        function updateListenUserList ( userList )
        {
            try
            {
                // 确保用户列表是数组
                if ( !Array.isArray( userList ) )
                {
                    if ( typeof userList === 'string' )
                    {
                        userList = userList.split( ',' ).map( item => item.trim() ).filter( item => item );
                    } else
                    {
                        console.error( "无效的用户列表格式:", userList );
                        return;
                    }
                }

                console.log( "更新监听用户列表:", userList );

                // 获取隐藏的input和用户列表显示元素
                const listenListInput = document.getElementById( 'LISTEN_LIST' );
                const userListElement = document.getElementById( 'selected_users_LISTEN_LIST' );

                if ( !listenListInput || !userListElement )
                {
                    console.error( "找不到监听用户列表元素" );
                    return;
                }

                // 清空当前显示
                userListElement.innerHTML = '';

                // 更新隐藏的input值
                if ( Array.isArray( userList ) )
                {
                    listenListInput.value = userList.join( ',' );
                } else
                {
                    listenListInput.value = userList;
                }

                // 如果是字符串，转换为数组进行处理
                const usersArray = Array.isArray( userList ) ? userList : userList.split( ',' ).map( item => item.trim() ).filter( item => item );

                // 重新创建用户列表项
                usersArray.forEach( user =>
                {
                    if ( user )
                    {
                        const userDiv = document.createElement( 'div' );
                        userDiv.className = 'list-group-item d-flex justify-content-between align-items-center';
                        userDiv.innerHTML = `
                            ${ user }
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeUser('LISTEN_LIST', '${ user }')">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        `;
                        userListElement.appendChild( userDiv );
                    }
                } );

                // 更新任务对话框中的发送对象选项
                updateTaskChatIdOptions();

                console.log( "监听用户列表更新完成" );
            } catch ( e )
            {
                console.error( "更新监听用户列表出错:", e );
            }
        }

        function processFormValue ( config, key, value )
        {
            if ( key === 'LISTEN_LIST' )
            {
                config[ key ] = value.split( ',' ).map( item => item.trim() ).filter( item => item );
            } else if ( key === 'TEMPERATURE' )
            {
                // 特殊处理温度参数
                const tempValue = parseFloat( value );
                if ( !isNaN( tempValue ) )
                {
                    config[ key ] = tempValue;
                }
            } else if ( key === 'TASKS' )
            {
                try
                {
                    config[ key ] = JSON.parse( value );
                } catch ( e )
                {
                    config[ key ] = [];
                }
            } else if ( value.toLowerCase() === 'true' || value.toLowerCase() === 'false' )
            {
                config[ key ] = value.toLowerCase() === 'true';
            } else if ( !isNaN( value ) && value !== '' )
            {
                config[ key ] = Number( value );
            } else
            {
                config[ key ] = value;
            }
        }

        // 添加新函数
        function addToListFromSelect ( key, value )
        {
            if ( value === 'add_new' )
            {
                document.getElementById( 'new_input_' + key ).style.display = 'flex';
                setTimeout( () =>
                {
                    document.querySelector( `select[onchange*="${ key }"]` ).value = '';
                }, 100 );
                return;
            }

            if ( value )
            {
                const targetElement = document.getElementById( key );
                const currentValues = targetElement.value ? targetElement.value.split( ',' ) : [];
                if ( !currentValues.includes( value ) )
                {
                    currentValues.push( value );
                    targetElement.value = currentValues.join( ',' );

                    // 添加到用户列表显示
                    const userListElement = document.getElementById( 'selected_users_' + key );
                    const userDiv = document.createElement( 'div' );
                    userDiv.className = 'list-group-item d-flex justify-content-between align-items-center';
                    userDiv.innerHTML = `
                        ${ value }
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeUser('${ key }', '${ value }')">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    `;
                    userListElement.appendChild( userDiv );
                }
            }
        }

        function addNewUser ( key )
        {
            const inputElement = document.getElementById( 'input_' + key );
            const newValue = inputElement.value.trim();

            if ( newValue )
            {
                const targetElement = document.getElementById( key );
                const currentValues = targetElement.value ? targetElement.value.split( ',' ) : [];
                if ( !currentValues.includes( newValue ) )
                {
                    currentValues.push( newValue );
                    targetElement.value = currentValues.join( ',' );

                    // 添加到用户列表显示
                    const userListElement = document.getElementById( 'selected_users_' + key );
                    const userDiv = document.createElement( 'div' );
                    userDiv.className = 'list-group-item d-flex justify-content-between align-items-center';
                    userDiv.innerHTML = `
                        ${ newValue }
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeUser('${ key }', '${ newValue }')">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    `;
                    userListElement.appendChild( userDiv );

                    // 清空输入框
                    inputElement.value = '';
                }
            }
            updateTaskChatIdOptions();
        }

        function removeUser ( key, userToRemove )
        {
            const targetElement = document.getElementById( key );
            const userListElement = document.getElementById( 'selected_users_' + key );

            // 更新隐藏的input值
            let currentValues = targetElement.value ? targetElement.value.split( ',' ) : [];
            currentValues = currentValues.filter( user => user !== userToRemove );
            targetElement.value = currentValues.join( ',' );

            // 从显示列表中移除
            const userElements = userListElement.getElementsByClassName( 'list-group-item' );
            for ( let element of userElements )
            {
                if ( element.textContent.trim() === userToRemove )
                {
                    element.remove();
                    break;
                }
            }
            updateTaskChatIdOptions();
        }

        // 添加背景图片上传处理
        document.getElementById( 'backgroundInput' ).addEventListener( 'change', function ( e )
        {
            const file = e.target.files[ 0 ];
            if ( file )
            {
                const formData = new FormData();
                formData.append( 'background', file );

                fetch( '/upload_background', {
                    method: 'POST',
                    body: formData
                } )
                    .then( response => response.json() )
                    .then( data =>
                    {
                        if ( data.status === 'success' )
                        {
                            document.body.style.backgroundImage = `url('${ data.path }')`;
                            showToast( data.message, 'success' );
                        } else
                        {
                            showToast( data.message, 'danger' );
                        }
                    } )
                    .catch( error =>
                    {
                        showToast( '上传失败：' + error, 'danger' );
                    } );
            }
        } );

        function updateTemperature ( key, value )
        {
            const displayElement = document.getElementById( key + '_display' );
            if ( displayElement )
            {
                displayElement.classList.add( 'updating' );
                displayElement.textContent = parseFloat( value ).toFixed( 1 );

                setTimeout( () =>
                {
                    displayElement.classList.remove( 'updating' );
                }, 300 );
            }
        }

        function showSaveNotification ( message, type = 'success' )
        {
            const notification = document.getElementById( 'saveNotification' );
            const messageElement = document.getElementById( 'saveNotificationMessage' );

            // 移除现有的背景色类
            notification.classList.remove( 'bg-success', 'bg-danger' );

            // 根据类型设置样式
            if ( type === 'success' )
            {
                notification.classList.add( 'bg-success' );
            } else
            {
                notification.classList.add( 'bg-danger' );
            }

            messageElement.textContent = message;

            const toast = new bootstrap.Toast( notification, {
                animation: true,
                autohide: true,
                delay: 3000
            } );
            toast.show();
        }

        // 修改显示添加任务模态框时的处理
        document.getElementById( 'addTaskModal' ).addEventListener( 'show.bs.modal', function ()
        {
            // 重置表单
            document.getElementById( 'taskForm' ).reset();

            // 填充发送对象下拉框
            const chatSelect = document.getElementById( 'taskChatId' );
            chatSelect.innerHTML = '<option value="">请选择发送对象</option>';

            // 从监听列表获取用户
            const userElements = document.querySelectorAll( '#selected_users_LISTEN_LIST .list-group-item' );
            userElements.forEach( element =>
            {
                const userName = element.textContent.trim();
                if ( userName )
                {
                    chatSelect.innerHTML += `<option value="${ userName }">${ userName }</option>`;
                }
            } );

            // 重置日期选择模式
            dateMode = false;
            selectedDates = [];
            document.getElementById( 'selectedDates' ).innerHTML = '';
            updateCronExpression();
        } );

        // 添加一个函数来更新任务对话框中的发送对象选项
        function updateTaskChatIdOptions ()
        {
            const chatSelect = document.getElementById( 'taskChatId' );
            if ( chatSelect )
            {
                const currentValue = chatSelect.value;
                chatSelect.innerHTML = '<option value="">请选择发送对象</option>';

                const userElements = document.querySelectorAll( '#selected_users_LISTEN_LIST .list-group-item' );
                userElements.forEach( element =>
                {
                    const userName = element.textContent.trim();
                    if ( userName )
                    {
                        chatSelect.innerHTML += `<option value="${ userName }">${ userName }</option>`;
                    }
                } );

                // 保持原来选中的值
                if ( currentValue )
                {
                    chatSelect.value = currentValue;
                }
            }
        }

        // 添加保存任务的函数
        function saveTask ()
        {
            const taskId = document.getElementById( 'taskId' ).value.trim();
            const chatId = document.getElementById( 'taskChatId' ).value;
            const content = document.getElementById( 'taskContent' ).value.trim();
            const cronExp = document.getElementById( 'cronExpression' ).value.trim();

            // 验证必填字段
            if ( !taskId || !chatId || !content )
            {
                showSaveNotification( '请填写所有必填字段', 'error' );
                return;
            }

            if ( !cronExp )
            {
                // 如果没有cron表达式，重新生成
                updateCronExpression();
            }

            // 创建任务对象
            const task = {
                task_id: taskId,
                chat_id: chatId,
                content: content,
                schedule_type: 'cron',
                schedule_time: document.getElementById( 'cronExpression' ).value,
                is_active: true
            };

            // 获取现有的任务列表
            let tasks = [];
            try
            {
                const tasksInput = document.getElementById( 'TASKS' );
                if ( tasksInput && tasksInput.value )
                {
                    tasks = JSON.parse( tasksInput.value );
                }
            } catch ( e )
            {
                console.error( '解析任务列表失败:', e );
            }

            // 更新任务列表
            const existingIndex = tasks.findIndex( t => t.task_id === taskId );
            if ( existingIndex >= 0 )
            {
                tasks[ existingIndex ] = task;
            } else
            {
                tasks.push( task );
            }

            // 更新隐藏输入框的值
            document.getElementById( 'TASKS' ).value = JSON.stringify( tasks );

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance( document.getElementById( 'addTaskModal' ) );
            modal.hide();

            // 显示成功提示
            showSaveNotification( '任务已添加，请点击底部的"保存所有设置"按钮保存更改' );

            // 刷新任务列表
            updateTaskList();
        }

        // 修改更新任务列表的函数
        function updateTaskList ()
        {
            const container = document.getElementById( 'taskListContainer' );
            if ( !container ) return;

            // 获取任务列表
            let tasks = [];
            try
            {
                const tasksInput = document.getElementById( 'TASKS' );
                if ( tasksInput && tasksInput.value )
                {
                    tasks = JSON.parse( tasksInput.value );
                }
            } catch ( e )
            {
                console.error( '解析任务列表失败:', e );
            }

            // 更新显示
            container.innerHTML = tasks.length === 0 ? `
                <div class="text-center text-muted p-4">
                    <i class="bi bi-inbox fs-2"></i>
                    <p class="mt-2">暂无定时任务</p>
                </div>
            ` : tasks.map( task => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="me-auto">
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge bg-primary me-2">${ task.task_id }</span>
                                <small class="text-muted">Cron: ${ task.schedule_time }</small>
                            </div>
                            <div class="mb-1">发送给：${ task.chat_id }</div>
                            <small class="text-muted">${ task.content }</small>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteTask('${ task.task_id }')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `).join( '' );
        }

        function deleteTask ( taskId )
        {
            if ( confirm( '确定要删除这个任务吗？' ) )
            {
                // 获取当前任务列表
                let tasks = [];
                try
                {
                    const tasksInput = document.getElementById( 'TASKS' );
                    if ( tasksInput && tasksInput.value )
                    {
                        tasks = JSON.parse( tasksInput.value );
                    }
                } catch ( e )
                {
                    return;
                }

                // 删除指定任务
                tasks = tasks.filter( t => t.task_id !== taskId );

                // 更新隐藏输入框的值
                document.getElementById( 'TASKS' ).value = JSON.stringify( tasks );

                // 刷新任务列表显示
                updateTaskList();

                showSaveNotification( '任务已删除，请点击底部的"保存所有设置"按钮保存更改' );
            }
        }

        // 日历功能相关变量
        let currentDate = new Date();
        let selectedDates = [];
        let dateMode = false; // false表示"每天"模式，true表示"特定日期"模式

        // 显示日历模态框
        function showCalendar ()
        {
            generateCalendar( currentDate.getFullYear(), currentDate.getMonth() );
            const calendarModal = new bootstrap.Modal( document.getElementById( 'calendarModal' ) );
            calendarModal.show();
        }

        // 生成日历
        function generateCalendar ( year, month )
        {
            const firstDay = new Date( year, month, 1 );
            const lastDay = new Date( year, month + 1, 0 );
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            // 更新当前月份显示
            const monthNames = [ "1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月" ];
            document.getElementById( 'currentMonth' ).textContent = `${ year }年${ monthNames[ month ] }`;

            const calendarBody = document.getElementById( 'calendarBody' );
            calendarBody.innerHTML = '';

            // 添加上个月的日期
            const prevMonthLastDay = new Date( year, month, 0 ).getDate();
            for ( let i = 0; i < startDayOfWeek; i++ )
            {
                const dayElement = document.createElement( 'div' );
                const day = prevMonthLastDay - startDayOfWeek + i + 1;
                dayElement.className = 'calendar-day other-month';
                dayElement.textContent = day;
                calendarBody.appendChild( dayElement );
            }

            // 添加当前月的日期
            const today = new Date();
            for ( let i = 1; i <= daysInMonth; i++ )
            {
                const dayElement = document.createElement( 'div' );
                dayElement.className = 'calendar-day';
                dayElement.textContent = i;

                // 添加自定义动画延迟
                dayElement.style.animationDelay = `${ i * 0.01 }s`;

                // 检查是否是今天
                if ( year === today.getFullYear() && month === today.getMonth() && i === today.getDate() )
                {
                    dayElement.classList.add( 'today' );
                }

                // 检查是否被选中
                const dateStr = `${ year }-${ month + 1 }-${ i }`;
                if ( selectedDates.includes( dateStr ) )
                {
                    dayElement.classList.add( 'selected' );
                }

                // 修改点击事件，添加动画处理
                dayElement.addEventListener( 'click', function ()
                {
                    // 创建点击波纹效果
                    this.classList.remove( 'selected' );
                    void this.offsetWidth; // 触发重绘，重置动画

                    this.classList.toggle( 'selected' );
                    const day = parseInt( this.textContent );
                    const dateStr = `${ year }-${ month + 1 }-${ day }`;

                    if ( this.classList.contains( 'selected' ) )
                    {
                        if ( !selectedDates.includes( dateStr ) )
                        {
                            selectedDates.push( dateStr );
                        }
                    } else
                    {
                        selectedDates = selectedDates.filter( d => d !== dateStr );
                    }
                } );

                calendarBody.appendChild( dayElement );
            }

            // 添加下个月的日期
            const totalCells = 42; // 6行7列
            const remainingCells = totalCells - ( startDayOfWeek + daysInMonth );
            for ( let i = 1; i <= remainingCells; i++ )
            {
                const dayElement = document.createElement( 'div' );
                dayElement.className = 'calendar-day other-month';
                dayElement.textContent = i;
                calendarBody.appendChild( dayElement );
            }
        }

        // 全选当月所有日期
        function selectAllDays ()
        {
            const days = document.querySelectorAll( '.calendar-day:not(.other-month)' );
            days.forEach( day =>
            {
                day.classList.add( 'selected' );
                const dayNum = parseInt( day.textContent );
                const dateStr = `${ currentDate.getFullYear() }-${ currentDate.getMonth() + 1 }-${ dayNum }`;
                if ( !selectedDates.includes( dateStr ) )
                {
                    selectedDates.push( dateStr );
                }
            } );
        }

        // 选择工作日（周一到周五）
        function selectWeekdays ()
        {
            clearSelection();
            const days = document.querySelectorAll( '.calendar-day:not(.other-month)' );
            days.forEach( day =>
            {
                const dayNum = parseInt( day.textContent );
                const dayDate = new Date( currentDate.getFullYear(), currentDate.getMonth(), dayNum );
                const dayOfWeek = dayDate.getDay();

                // 0是周日，1-5是周一到周五，6是周六
                if ( dayOfWeek > 0 && dayOfWeek < 6 )
                {
                    day.classList.add( 'selected' );
                    const dateStr = `${ currentDate.getFullYear() }-${ currentDate.getMonth() + 1 }-${ dayNum }`;
                    if ( !selectedDates.includes( dateStr ) )
                    {
                        selectedDates.push( dateStr );
                    }
                }
            } );
        }

        // 选择周末（周六和周日）
        function selectWeekends ()
        {
            clearSelection();
            const days = document.querySelectorAll( '.calendar-day:not(.other-month)' );
            days.forEach( day =>
            {
                const dayNum = parseInt( day.textContent );
                const dayDate = new Date( currentDate.getFullYear(), currentDate.getMonth(), dayNum );
                const dayOfWeek = dayDate.getDay();

                // 0是周日，6是周六
                if ( dayOfWeek === 0 || dayOfWeek === 6 )
                {
                    day.classList.add( 'selected' );
                    const dateStr = `${ currentDate.getFullYear() }-${ currentDate.getMonth() + 1 }-${ dayNum }`;
                    if ( !selectedDates.includes( dateStr ) )
                    {
                        selectedDates.push( dateStr );
                    }
                }
            } );
        }

        // 清除选择
        function clearSelection ()
        {
            const days = document.querySelectorAll( '.calendar-day.selected' );
            days.forEach( day =>
            {
                day.classList.remove( 'selected' );
            } );
            selectedDates = [];
        }

        // 确认日期选择
        function confirmDateSelection ()
        {
            // 如果没有选择日期，则切换回每天模式
            if ( selectedDates.length === 0 )
            {
                dateMode = false;
                updateCronExpression();

                // 添加一个牛逼的关闭效果
                const modalElement = document.getElementById( 'calendarModal' );
                modalElement.classList.add( 'fade-out' );

                setTimeout( () =>
                {
                    bootstrap.Modal.getInstance( modalElement ).hide();
                    modalElement.classList.remove( 'fade-out' );
                }, 300 );
                return;
            }

            // 添加选择确认的视觉反馈
            const selectedElements = document.querySelectorAll( '.calendar-day.selected' );
            selectedElements.forEach( ( el, index ) =>
            {
                // 添加闪烁效果
                setTimeout( () =>
                {
                    el.style.animation = 'pulse 0.3s';
                }, index * 50 );
            } );

            // 等待动画完成后再关闭
            setTimeout( () =>
            {
                dateMode = true;
                updateSelectedDatesDisplay();
                updateCronExpression();
                bootstrap.Modal.getInstance( document.getElementById( 'calendarModal' ) ).hide();
            }, 300 );
        }

        // 更新选中日期的显示
        function updateSelectedDatesDisplay ()
        {
            const container = document.getElementById( 'selectedDates' );

            if ( selectedDates.length === 0 )
            {
                container.innerHTML = '';
                return;
            }

            // 排序日期
            selectedDates.sort();

            // 显示选中的日期
            container.innerHTML = `<div class="mt-2 text-primary"><i class="bi bi-calendar-check me-1"></i>已选择 ${ selectedDates.length } 个日期</div>`;

            // 日期过多，显示部分
            let displayDates = selectedDates;
            if ( selectedDates.length > 5 )
            {
                displayDates = selectedDates.slice( 0, 5 );
                container.innerHTML += `<div class="d-flex flex-wrap mt-1">
                    ${ displayDates.map( d => `<span class="badge bg-primary me-1 mb-1">${ d }</span>` ).join( '' ) }
                    <span class="badge bg-secondary">+${ selectedDates.length - 5 }个</span>
                </div>`;
            } else
            {
                container.innerHTML += `<div class="d-flex flex-wrap mt-1">
                    ${ displayDates.map( d => `<span class="badge bg-primary me-1 mb-1">${ d }</span>` ).join( '' ) }
                </div>`;
            }
        }

        // 修改月份切换的处理函数
        document.getElementById( 'prevMonth' ).addEventListener( 'click', function ()
        {
            const calendarBody = document.getElementById( 'calendarBody' );
            const currentMonthEl = document.getElementById( 'currentMonth' );

            // 添加退出动画
            calendarBody.style.animation = 'slideInRight 0.3s forwards';
            currentMonthEl.style.animation = 'slideInRight 0.3s forwards';

            // 在动画结束后更新日历
            setTimeout( () =>
            {
                currentDate.setMonth( currentDate.getMonth() - 1 );
                generateCalendar( currentDate.getFullYear(), currentDate.getMonth() );

                // 重设动画
                calendarBody.style.animation = '';
                currentMonthEl.style.animation = '';
            }, 150 );
        } );

        document.getElementById( 'nextMonth' ).addEventListener( 'click', function ()
        {
            const calendarBody = document.getElementById( 'calendarBody' );
            const currentMonthEl = document.getElementById( 'currentMonth' );

            // 添加退出动画
            calendarBody.style.animation = 'slideInLeft 0.3s forwards';
            currentMonthEl.style.animation = 'slideInLeft 0.3s forwards';

            // 在动画结束后更新日历
            setTimeout( () =>
            {
                currentDate.setMonth( currentDate.getMonth() + 1 );
                generateCalendar( currentDate.getFullYear(), currentDate.getMonth() );

                // 重设动画
                calendarBody.style.animation = '';
                currentMonthEl.style.animation = '';
            }, 150 );
        } );

        // 更新Cron表达式的函数，支持特定日期
        function updateCronExpression ()
        {
            const minute = document.getElementById( 'cronMinute' ).value;
            const hour = document.getElementById( 'cronHour' ).value;

            let cronExp;
            let description;

            if ( dateMode && selectedDates.length > 0 )
            {
                // 特定日期模式
                // 提取所有日期的日和月
                const days = {};
                selectedDates.forEach( dateStr =>
                {
                    const [ year, month, day ] = dateStr.split( '-' ).map( Number );
                    if ( !days[ month ] ) days[ month ] = [];
                    days[ month ].push( day );
                } );

                // 构建月和日的表达式
                const monthsExp = Object.keys( days ).join( ',' );

                // 为每个月构建天数表达式
                let daysExp = '';
                for ( const month in days )
                {
                    if ( daysExp ) daysExp += ',';
                    daysExp += days[ month ].join( ',' );
                }

                cronExp = `${ minute } ${ hour } ${ daysExp } ${ monthsExp } *`;
                description = `选定的 ${ selectedDates.length } 天，每天 ${ hour.padStart( 2, '0' ) }:${ minute.padStart( 2, '0' ) }`;
            } else
            {
                // 每天模式
                cronExp = `${ minute } ${ hour } * * *`;
                description = `每天 ${ hour.padStart( 2, '0' ) }:${ minute.padStart( 2, '0' ) }`;
            }

            // 更新隐藏的Cron表达式输入框
            document.getElementById( 'cronExpression' ).value = cronExp;

            // 更新描述文本
            document.getElementById( 'cronDescription' ).textContent = description;
        }

        // 函数结束点之前添加RAG相关的JavaScript函数

        // RAG记忆相关的函数
        // 更新RAG API提供商
        function updateRagApiProvider ( provider )
        {
            console.log( "更新RAG API提供商:", provider );

            const customApiInput = document.getElementById( 'rag_customApiInput' );
            const baseUrlInput = document.getElementById( 'RAG_BASE_URL' );

            if ( provider === 'custom' )
            {
                customApiInput.style.display = 'block';
                const customUrl = document.getElementById( 'rag_custom_url' ).value;
                baseUrlInput.value = customUrl || '';
            } else
            {
                customApiInput.style.display = 'none';
                const select = document.getElementById( 'rag_api_provider_select' );
                const option = select.options[ select.selectedIndex ];
                baseUrlInput.value = option.dataset.url || '';
            }

            // 更新嵌入和重排序URL
            updateApiUrls( baseUrlInput.value );

            // 先清除当前选择的嵌入模型值，以确保能够正确更新
            const embeddingModelField = document.getElementById( 'RAG_EMBEDDING_MODEL' );
            const currentEmbeddingModel = embeddingModelField.value;
            console.log( "切换API提供商前的嵌入模型值:", currentEmbeddingModel );

            // 对于硅基流动提供商，强制重置为其推荐的嵌入模型
            if ( provider === 'siliconflow' )
            {
                // 检查当前模型是否是硅基流动支持的模型
                const siliconflowModels = [
                    'BAAI/bge-m3',
                    'BAAI/bge-large-zh-v1.5', 'BAAI/bge-large-en-v1.5',
                    'Pro/BAAI/bge-m3'
                ];

                if ( !siliconflowModels.includes( currentEmbeddingModel ) )
                {
                    console.log( "检测到非硅基流动模型，重置为推荐模型" );
                    embeddingModelField.value = 'BAAI/bge-m3';
                }
            }

            // 更新嵌入模型选项
            updateEmbeddingModelOptions( provider );

            // 更新重排序模型选项
            updateRerankerModelOptions( provider );
        }

        // 更新嵌入模型选项
        function updateEmbeddingModelOptions ( provider )
        {
            const embeddingSelect = document.getElementById( 'rag_embedding_model_select' );
            const currentValue = document.getElementById( 'RAG_EMBEDDING_MODEL' ).value; // 保存当前值
            console.log( "更新模型选项前，当前值:", currentValue, "提供商:", provider );

            embeddingSelect.innerHTML = ''; // 清空现有选项

            let options = [];


            if ( provider === 'kourichat' )
            {
                options = [
                    { value: 'text-embedding-3-large', text: 'text-embedding-3-large' },
                    { value: 'bge-m3', text: 'bge-m3' },
                    { value: 'text-embedding-ada-002', text: 'text-embedding-ada-002' },
                    { value: 'text-embedding-v1', text: 'text-embedding-v1' }
                ];
                console.log( "加载KouriChat嵌入模型选项" );
            } else if ( provider === 'ciallo' )
            {
                options = [
                    { value: 'text-embedding-3-large', text: 'text-embedding-3-large' },
                    { value: 'bge-m3', text: 'bge-m3' },
                    { value: 'text-embedding-ada-002', text: 'text-embedding-ada-002' },
                    { value: 'text-embedding-v1', text: 'text-embedding-v1' }
                ];
                console.log( "加载KouriChat嵌入模型选项" );
            } else if ( provider === 'siliconflow' )
            {
                options = [
                    { value: 'BAAI/bge-m3', text: 'BAAI/bge-m3 ' },
                    { value: 'BAAI/bge-large-zh-v1.5', text: 'BAAI/bge-large-zh-v1.5' },
                    { value: 'BAAI/bge-large-en-v1.5', text: 'BAAI/bge-large-en-v1.5' },
                    { value: 'Pro/BAAI/bge-m3', text: 'Pro/BAAI/bge-m3' }
                ];
                console.log( "加载硅基流动嵌入模型选项" );

                // 对于硅基流动，检查当前模型是否在列表中
                let foundInSiliconflow = false;
                if ( currentValue )
                {
                    for ( const option of options )
                    {
                        if ( option.value === currentValue )
                        {
                            foundInSiliconflow = true;
                            break;
                        }
                    }
                }

                if ( !foundInSiliconflow && provider === 'siliconflow' )
                {
                    // 如果当前嵌入模型不在硅基流动的选项中，重置为推荐模型
                    console.log( "当前嵌入模型不在硅基流动选项中，重置为推荐模型" );
                    document.getElementById( 'RAG_EMBEDDING_MODEL' ).value = 'BAAI/bge-m3';
                }
            } else
            {
                console.log( "未知的提供商类型:", provider );
            }

            // 添加自定义选项
            options.push( { value: 'custom', text: '自定义模型' } );

            // 添加选项到下拉框
            options.forEach( option =>
            {
                const optElement = document.createElement( 'option' );
                optElement.value = option.value;
                optElement.textContent = option.text;
                embeddingSelect.appendChild( optElement );
            } );

            console.log( "已添加", options.length, "个选项到嵌入模型下拉框" );

            // 获取更新后的当前值（可能已在上面的代码中更改）
            const updatedCurrentValue = document.getElementById( 'RAG_EMBEDDING_MODEL' ).value;

            // 更新后，恢复之前选择的值或使用默认值
            if ( updatedCurrentValue )
            {
                let found = false;
                for ( let i = 0; i < embeddingSelect.options.length; i++ )
                {
                    if ( embeddingSelect.options[ i ].value === updatedCurrentValue )
                    {
                        embeddingSelect.value = updatedCurrentValue;
                        found = true;
                        break;
                    }
                }

                if ( !found )
                {
                    embeddingSelect.value = 'custom';
                    const customEmbeddingInput = document.getElementById( 'rag_customEmbeddingInput' );
                    customEmbeddingInput.style.display = 'block';
                    const customEmbeddingField = document.getElementById( 'rag_custom_embedding' );
                    customEmbeddingField.value = updatedCurrentValue;
                }

                console.log( "更新模型选项后，设置选择框值为:", embeddingSelect.value );
            } else
            {
                // 如果没有当前值，选择第一个选项
                embeddingSelect.selectedIndex = 0;
                // 并将选中的值同步到隐藏字段
                document.getElementById( 'RAG_EMBEDDING_MODEL' ).value = embeddingSelect.value;
                console.log( "没有当前值，设置为第一个选项:", embeddingSelect.value );
            }
        }

        // 更新重排序模型选项
        function updateRerankerModelOptions ( provider )
        {
            const rerankerSelect = document.getElementById( 'rag_reranker_model_select' );
            const currentValue = document.getElementById( 'RAG_RERANKER_MODEL' ).value; // 保存当前值
            const currentSelectValue = rerankerSelect.value; // 保存当前选择框的值

            console.log( "更新重排序模型选项前，当前值:", currentValue, "选择框值:", currentSelectValue );

            rerankerSelect.innerHTML = ''; // 清空现有选项

            // 根据提供商添加特定选项
            let options = [];

            if ( provider === 'kouri' )
            {
                options = [
                    { value: 'deepseek-v3', text: 'deepseek-v3' },
                    { value: 'deepseek-r1', text: 'deepseek-r1' },
                    { value: 'bge-reranker-v2-m3', text: 'bge-reranker-v2-m3' },
                    { value: 'kourichat-r1', text: 'kourichat-r1' },
                    { value: 'kourichat-v3', text: 'kourichat-v3' }
                ];
            } else if ( provider === 'kourichat' )
            {
                options = [
                    { value: 'bge-reranker-v2-m3', text: 'bge-reranker-v2-m3 (推荐)' }
                ];
            } else if ( provider === 'ciallo' )
            {
                options = [
                    { value: 'bge-reranker-v2-m3', text: 'bge-reranker-v2-m3 (推荐)' }
                ];
            } else if ( provider === 'siliconflow' )
            {
                options = [
                    { value: 'BAAI/bge-reranker-v2-m3', text: 'BAAI/bge-reranker-v2-m3' },
                    { value: 'netease-youdao/bce-reranker-base_v1', text: 'netease-youdao/bce-reranker-base_v1' }
                ];
            }

            // 添加所有选项到下拉框
            options.forEach( option =>
            {
                const optElement = document.createElement( 'option' );
                optElement.value = option.value;
                optElement.textContent = option.text;
                rerankerSelect.appendChild( optElement );
            } );

            // 添加自定义选项
            const customOption = document.createElement( 'option' );
            customOption.value = 'custom';
            customOption.textContent = '自定义模型';
            rerankerSelect.appendChild( customOption );

            // 更新后，恢复之前选择的值
            let valueToRestore = '';

            // 如果有当前隐藏值，尝试使用它
            if ( currentValue )
            {
                let found = false;
                for ( let i = 0; i < rerankerSelect.options.length; i++ )
                {
                    if ( rerankerSelect.options[ i ].value === currentValue )
                    {
                        valueToRestore = currentValue;
                        found = true;
                        break;
                    }
                }

                // 如果没找到匹配的选项但有隐藏值，使用自定义
                if ( !found )
                {
                    valueToRestore = 'custom';
                    const customRerankerInput = document.getElementById( 'rag_customRerankerInput' );
                    if ( customRerankerInput )
                    {
                        customRerankerInput.style.display = 'block';
                        const customRerankerField = document.getElementById( 'rag_custom_reranker' );
                        if ( customRerankerField )
                        {
                            customRerankerField.value = currentValue;
                        }
                    }
                }
            }
            // 如果没有隐藏值但有选择框值，尝试使用选择框值
            else if ( currentSelectValue )
            {
                let exists = false;
                for ( let i = 0; i < rerankerSelect.options.length; i++ )
                {
                    if ( rerankerSelect.options[ i ].value === currentSelectValue )
                    {
                        valueToRestore = currentSelectValue;
                        exists = true;
                        break;
                    }
                }

                // 如果选择框的值在新选项中不存在，使用自定义
                if ( !exists )
                {
                    valueToRestore = 'custom';
                }
            }
            // 如果既没有隐藏值也没有选择框值，使用第一个可用选项
            else
            {
                if ( rerankerSelect.options.length > 0 )
                {
                    valueToRestore = rerankerSelect.options[ 0 ].value;
                } else
                {
                    valueToRestore = 'custom';
                }
            }

            // 设置选择框的值
            rerankerSelect.value = valueToRestore;

            console.log( "更新重排序模型选项后，设置选择框值为:", valueToRestore );

            // 根据设置的值更新UI状态
            updateRagRerankerModel( valueToRestore );
        }

        // 更新RAG自定义API URL
        function updateRagCustomApiUrl ( url )
        {
            document.getElementById( 'RAG_BASE_URL' ).value = url;
            // 同时更新嵌入和重排序URL
            updateApiUrls( url );
        }

        // 更新RAG嵌入模型
        function updateRagEmbeddingModel ( model )
        {
            const customEmbeddingInput = document.getElementById( 'rag_customEmbeddingInput' );
            const embeddingModelInput = document.getElementById( 'RAG_EMBEDDING_MODEL' );
            const embeddingSelect = document.getElementById( 'rag_embedding_model_select' );

            console.log( "更新RAG嵌入模型 - 调用开始:", model );

            if ( model === 'custom' )
            {
                customEmbeddingInput.style.display = 'block';

                // 如果有自定义值，使用它，否则保留当前值
                const customModel = document.getElementById( 'rag_custom_embedding' ).value;
                if ( customModel )
                {
                    embeddingModelInput.value = customModel;
                } else if ( embeddingModelInput.value && embeddingModelInput.value !== 'custom' )
                {
                    // 如果隐藏字段有非自定义值，将其设置为自定义输入框的值
                    document.getElementById( 'rag_custom_embedding' ).value = embeddingModelInput.value;
                }
            } else
            {
                customEmbeddingInput.style.display = 'none';
                if ( model )
                {
                    embeddingModelInput.value = model;
                }

                // 确保下拉框选项与选择的值一致
                if ( embeddingSelect && model )
                {
                    embeddingSelect.value = model;
                }
            }

            // 触发变更事件，确保表单能捕获到值的变化
            if ( embeddingModelInput )
            {
                const event = new Event( 'change', { bubbles: true } );
                embeddingModelInput.dispatchEvent( event );
            }

            console.log( "更新RAG嵌入模型 - 调用结束:",
                "model参数:", model,
                "当前选择框值:", embeddingSelect ? embeddingSelect.value : "无选择框",
                "当前隐藏值:", embeddingModelInput.value );
        }

        // 更新RAG自定义嵌入模型
        function updateRagCustomEmbedding ( model )
        {
            const embeddingModelInput = document.getElementById( 'RAG_EMBEDDING_MODEL' );
            if ( model && model.trim() )
            {
                const newValue = model.trim();
                embeddingModelInput.value = newValue;

                // 确保选择框选中"自定义"选项
                const embeddingSelect = document.getElementById( 'rag_embedding_model_select' );
                if ( embeddingSelect )
                {
                    embeddingSelect.value = 'custom';
                }

                // 触发变更事件
                const event = new Event( 'change', { bubbles: true } );
                embeddingModelInput.dispatchEvent( event );
                console.log( "更新RAG自定义嵌入模型:", newValue );
            }
        }

        // 更新RAG重排序模型
        function updateRagRerankerModel ( model )
        {
            const customRerankerInput = document.getElementById( 'rag_customRerankerInput' );
            const rerankerModelInput = document.getElementById( 'RAG_RERANKER_MODEL' );
            const rerankerSelect = document.getElementById( 'rag_reranker_model_select' );

            console.log( "更新RAG重排序模型 - 调用开始:", model );

            if ( model === 'custom' )
            {
                customRerankerInput.style.display = 'block';
                const customModel = document.getElementById( 'rag_custom_reranker' ).value;
                if ( customModel )
                {
                    rerankerModelInput.value = customModel;
                } else if ( rerankerModelInput.value && rerankerModelInput.value !== 'custom' )
                {
                    // 如果隐藏字段有非自定义值，将其设置为自定义输入框的值
                    document.getElementById( 'rag_custom_reranker' ).value = rerankerModelInput.value;
                }
            } else
            {
                customRerankerInput.style.display = 'none';
                if ( model )
                {
                    rerankerModelInput.value = model;
                }
            }

            // 确保下拉框选项与选择的值一致
            if ( rerankerSelect && model )
            {
                rerankerSelect.value = model;
            }

            // 触发变更事件，确保表单能捕获到值的变化
            if ( rerankerModelInput )
            {
                const event = new Event( 'change', { bubbles: true } );
                rerankerModelInput.dispatchEvent( event );
            }

            console.log( "更新RAG重排序模型 - 调用结束:",
                "model参数:", model,
                "当前选择框值:", rerankerSelect ? rerankerSelect.value : "无选择框",
                "当前隐藏值:", rerankerModelInput.value );
        }

        // 更新RAG自定义重排序模型
        function updateRagCustomReranker ( model )
        {
            const rerankerModelInput = document.getElementById( 'RAG_RERANKER_MODEL' );
            if ( model && model.trim() )
            {
                const newValue = model.trim();
                rerankerModelInput.value = newValue;

                // 确保选择框选中"自定义"选项
                const rerankerSelect = document.getElementById( 'rag_reranker_model_select' );
                if ( rerankerSelect )
                {
                    rerankerSelect.value = 'custom';
                }

                // 触发变更事件
                const event = new Event( 'change', { bubbles: true } );
                rerankerModelInput.dispatchEvent( event );
                console.log( "更新RAG自定义重排序模型:", newValue );
            }
        }

        // 更新RAG检索数量
        function updateRagTopK ( value )
        {
            document.getElementById( 'RAG_TOP_K_display' ).textContent = value;
            document.getElementById( 'RAG_TOP_K' ).value = value;
        }

        // 切换本地模型设置部分显示
        function toggleLocalModelSection ( enabled )
        {
            const localModelSettings = document.getElementById( 'local_model_settings' );
            if ( enabled )
            {
                localModelSettings.style.display = 'block';
            } else
            {
                localModelSettings.style.display = 'none';
            }
        }

        // 密码可见性切换
        function togglePasswordVisibility ( fieldId )
        {
            const field = document.getElementById( fieldId );
            const button = field.nextElementSibling;
            const icon = button.querySelector( 'i' );

            if ( field.type === 'password' )
            {
                field.type = 'text';
                icon.classList.remove( 'bi-eye' );
                icon.classList.add( 'bi-eye-slash' );
            } else
            {
                field.type = 'password';
                icon.classList.remove( 'bi-eye-slash' );
                icon.classList.add( 'bi-eye' );
            }
        }

        // 初始化RAG配置UI
        function initRagSettings ()
        {
            console.log( "开始初始化RAG设置" );

            // 首先尝试直接从localStorage获取用户保存的RAG配置状态
            let savedRerankState = false;
            let savedRagConfig = null;
            try
            {
                const savedConfig = localStorage.getItem( 'ragConfig' );
                if ( savedConfig )
                {
                    savedRagConfig = JSON.parse( savedConfig );
                    if ( savedRagConfig && typeof savedRagConfig.isRerank !== 'undefined' )
                    {
                        savedRerankState = Boolean( savedRagConfig.isRerank );
                        console.log( `从localStorage读取到的重排序状态: ${ savedRerankState }` );
                    }
                }
            } catch ( e )
            {
                console.error( "读取localStorage中RAG配置失败:", e );
            }

            // API提供者
            let baseUrl = document.getElementById( 'RAG_BASE_URL' ).value;
            const apiProviderSelect = document.getElementById( 'rag_api_provider_select' );
            const customApiInput = document.getElementById( 'rag_customApiInput' );
            const customUrlInput = document.getElementById( 'rag_custom_url' );

            // 处理可能的对象格式URL
            baseUrl = getApiUrlValue( baseUrl );

            let found = false;
            let selectedProvider = 'ciallo'; // 默认使用亚太备选

            // 提取基本URL（如果有/embeddings或/rerank后缀，将其移除）
            let cleanBaseUrl = baseUrl;
            if ( cleanBaseUrl )
            {
                // 移除尾部斜杠(如果有)
                if ( cleanBaseUrl.endsWith( '/' ) )
                {
                    cleanBaseUrl = cleanBaseUrl.slice( 0, -1 );
                }

                // 移除API后缀
                if ( cleanBaseUrl.endsWith( '/embeddings' ) || cleanBaseUrl.endsWith( '/rerank' ) )
                {
                    const parts = cleanBaseUrl.split( '/' );
                    parts.pop(); // 移除最后一个路径段
                    cleanBaseUrl = parts.join( '/' );
                }
            }

            // 查找匹配的API提供商
            for ( let i = 0; i < apiProviderSelect.options.length; i++ )
            {
                const option = apiProviderSelect.options[ i ];
                const optionUrl = option.dataset.url;

                // 移除选项URL的尾部斜杠(如果有)
                let cleanOptionUrl = optionUrl;
                if ( cleanOptionUrl && cleanOptionUrl.endsWith( '/' ) )
                {
                    cleanOptionUrl = cleanOptionUrl.slice( 0, -1 );
                }

                if ( cleanOptionUrl === cleanBaseUrl )
                {
                    apiProviderSelect.value = option.value;
                    selectedProvider = option.value;
                    found = true;
                    console.log( "找到匹配的API提供商:", option.value );
                    break;
                }
            }

            // 检测是否为硅基流动的URL
            if ( cleanBaseUrl && cleanBaseUrl.includes( 'siliconflow' ) )
            {
                apiProviderSelect.value = 'siliconflow';
                selectedProvider = 'siliconflow';
                found = true;
                console.log( "检测到硅基流动URL，强制设置为硅基流动提供商" );
            }

            // 如果没有匹配的预定义提供商，设置为自定义
            if ( !found && cleanBaseUrl )
            {
                apiProviderSelect.value = 'custom';
                selectedProvider = 'custom';
                customApiInput.style.display = 'block';
                customUrlInput.value = cleanBaseUrl;
            }

            // 更新基础URL值（不含后缀）
            document.getElementById( 'RAG_BASE_URL' ).value = cleanBaseUrl;

            // 更新嵌入和重排序URL
            updateApiUrls( cleanBaseUrl );

            // 记住当前嵌入模型的值，确保在后续处理中不会丢失
            const currentEmbeddingModel = document.getElementById( 'RAG_EMBEDDING_MODEL' ).value;

            console.log( "初始化前状态 - 嵌入模型:", currentEmbeddingModel, "API提供商:", selectedProvider );

            // 首先手动更新选项列表，确保选项与API提供商匹配
            let embeddingOptions = [];

            if ( selectedProvider === 'kourichat' )
            {
                embeddingOptions = [
                    { value: 'text-embedding-3-large', text: 'text-embedding-3-large' },
                    { value: 'bge-m3', text: 'bge-m3' },
                    { value: 'text-embedding-ada-002', text: 'text-embedding-ada-002' },
                    { value: 'text-embedding-v1', text: 'text-embedding-v1' }
                ];
            } else if ( selectedProvider === 'ciallo' )
            {
                embeddingOptions = [
                    { value: 'text-embedding-3-large', text: 'text-embedding-3-large' },
                    { value: 'bge-m3', text: 'bge-m3' },
                    { value: 'text-embedding-ada-002', text: 'text-embedding-ada-002' },
                    { value: 'text-embedding-v1', text: 'text-embedding-v1' }
                ];
            } else if ( selectedProvider === 'siliconflow' )
            {
                embeddingOptions = [
                    { value: 'BAAI/bge-m3', text: 'BAAI/bge-m3' },
                    { value: 'BAAI/bge-large-zh-v1.5', text: 'BAAI/bge-large-zh-v1.5' },
                    { value: 'BAAI/bge-large-en-v1.5', text: 'BAAI/bge-large-en-v1.5' },
                    { value: 'Pro/BAAI/bge-m3', text: 'Pro/BAAI/bge-m3' }
                ];
                console.log( "加载硅基流动嵌入模型选项" );

                // 对于硅基流动，检查当前模型是否在列表中
                let foundInSiliconflow = false;
                if ( currentValue )
                {
                    for ( const option of options )
                    {
                        if ( option.value === currentValue )
                        {
                            foundInSiliconflow = true;
                            break;
                        }
                    }
                }

                if ( !foundInSiliconflow && provider === 'siliconflow' )
                {
                    // 如果当前嵌入模型不在硅基流动的选项中，重置为推荐模型
                    console.log( "当前嵌入模型不在硅基流动选项中，重置为推荐模型" );
                    document.getElementById( 'RAG_EMBEDDING_MODEL' ).value = 'BAAI/bge-m3';
                }
            } else
            {
                console.log( "未知提供商，使用默认选项" );
                embeddingOptions = [
                    { value: 'BAAI/bge-m3', text: 'BAAI/bge-m3' }
                ];
            }

            // 添加自定义选项
            embeddingOptions.push( { value: 'custom', text: '自定义模型' } );

            // 嵌入模型 - 更新选项列表
            const embeddingSelect = document.getElementById( 'rag_embedding_model_select' );
            const customEmbeddingInput = document.getElementById( 'rag_customEmbeddingInput' );
            const customEmbeddingField = document.getElementById( 'rag_custom_embedding' );

            // 清空现有选项
            embeddingSelect.innerHTML = '';

            // 添加新选项
            embeddingOptions.forEach( option =>
            {
                const optElement = document.createElement( 'option' );
                optElement.value = option.value;
                optElement.textContent = option.text;
                embeddingSelect.appendChild( optElement );
            } );

            // 检查当前模型是否在选项列表中
            if ( currentEmbeddingModel )
            {
                let modelInOptions = false;
                for ( const option of embeddingOptions )
                {
                    if ( option.value === currentEmbeddingModel )
                    {
                        modelInOptions = true;
                        break;
                    }
                }

                if ( modelInOptions )
                {
                    // 如果当前模型在选项中，直接设置选择框
                    embeddingSelect.value = currentEmbeddingModel;
                    customEmbeddingInput.style.display = 'none';
                    console.log( "当前模型在选项列表中，设置选择框值为:", currentEmbeddingModel );
                } else
                {
                    // 如果当前模型不在选项中
                    if ( selectedProvider === 'siliconflow' )
                    {
                        // 对于硅基流动，如果模型不匹配，使用默认推荐模型
                        embeddingSelect.value = 'BAAI/bge-m3';
                        document.getElementById( 'RAG_EMBEDDING_MODEL' ).value = 'BAAI/bge-m3';
                        customEmbeddingInput.style.display = 'none';
                        console.log( "硅基流动提供商，但模型不匹配，重置为: BAAI/bge-m3" );
                    } else
                    {
                        // 对于其他提供商，使用自定义模型
                        embeddingSelect.value = 'custom';
                        customEmbeddingInput.style.display = 'block';
                        customEmbeddingField.value = currentEmbeddingModel;
                        console.log( "使用自定义模型:", currentEmbeddingModel );
                    }
                }
            } else
            {
                // 如果没有当前值，选择第一个选项并同步到隐藏字段
                embeddingSelect.selectedIndex = 0;
                document.getElementById( 'RAG_EMBEDDING_MODEL' ).value = embeddingSelect.value;
                console.log( "没有当前模型值，设置为第一个选项:", embeddingSelect.value );
            }

            // 更新重排序模型选项
            updateRerankerModelOptions( selectedProvider );

            // 重排序开关 - 特别处理
            const isRerankCheckbox = document.getElementById( 'RAG_IS_RERANK' );
            // 1. 首先获取当前实际值(从checkbox元素)
            let currentIsRerank = isRerankCheckbox ? isRerankCheckbox.checked : false;

            // 2. 如果从localStorage中读取到了用户保存的值，优先使用它
            if ( savedRerankState !== undefined && savedRagConfig )
            {
                currentIsRerank = savedRerankState;
                if ( isRerankCheckbox )
                {
                    console.log( `使用从localStorage读取的重排序状态: ${ savedRerankState }` );
                    isRerankCheckbox.checked = savedRerankState;
                }
            }

            // 3. 确保UI显示与当前值一致
            console.log( `初始化重排序开关状态: ${ currentIsRerank }` );
            toggleRerankModelSection( currentIsRerank );

            // 处理本地模型设置
            const localModelEnabled = document.getElementById( 'LOCAL_MODEL_ENABLED' ).checked;
            toggleLocalModelSection( localModelEnabled );

            // 保存当前配置到localStorage，以便页面刷新后能恢复状态
            try
            {
                const ragConfig = {
                    baseUrl: cleanBaseUrl,
                    embeddingModel: document.getElementById( 'RAG_EMBEDDING_MODEL' ).value,
                    rerankerModel: document.getElementById( 'RAG_RERANKER_MODEL' ).value,
                    isRerank: isRerankCheckbox ? isRerankCheckbox.checked : false,
                    savedTime: new Date().getTime()
                };
                localStorage.setItem( 'ragConfig', JSON.stringify( ragConfig ) );
                console.log( "已保存RAG配置到localStorage:", ragConfig );
            } catch ( e )
            {
                console.error( "保存RAG配置到localStorage失败:", e );
            }

            console.log( "RAG设置初始化完成" );
        }

        // 初始化安静时间设置
        function initQuietTimeSettings ()
        {
            const startTimeInput = document.getElementById( 'QUIET_TIME_START' );
            const endTimeInput = document.getElementById( 'QUIET_TIME_END' );
            const startTimeDisplay = document.getElementById( 'QUIET_TIME_START_display' );
            const endTimeDisplay = document.getElementById( 'QUIET_TIME_END_display' );

            if ( startTimeInput && startTimeDisplay )
            {
                const startValue = startTimeInput.value;
                if ( startValue )
                {
                    // 确保值被正确格式化为时间字符串
                    let formattedValue = startValue;
                    if ( startValue === '1320' )
                    {
                        // 特殊处理1320值为22:00
                        formattedValue = '22:00';
                    } else if ( startValue && !startValue.includes( ':' ) )
                    {
                        // 尝试将数字格式转换为时间格式 (如 "2200" -> "22:00")
                        if ( startValue.length === 4 )
                        {
                            formattedValue = `${ startValue.substring( 0, 2 ) }:${ startValue.substring( 2, 4 ) }`;
                        }
                    }
                    startTimeInput.value = formattedValue;
                    startTimeDisplay.value = formattedValue;
                }
            }

            if ( endTimeInput && endTimeDisplay )
            {
                const endValue = endTimeInput.value;
                if ( endValue )
                {
                    // 确保值被正确格式化为时间字符串
                    let formattedValue = endValue;
                    if ( endValue && !endValue.includes( ':' ) )
                    {
                        // 尝试将数字格式转换为时间格式 (如 "0800" -> "08:00")
                        if ( endValue.length === 4 )
                        {
                            formattedValue = `${ endValue.substring( 0, 2 ) }:${ endValue.substring( 2, 4 ) }`;
                        }
                    }
                    endTimeInput.value = formattedValue;
                    endTimeDisplay.value = formattedValue;
                }
            }
        }

        // 切换重排序模型部分显示
        function toggleRerankModelSection ( enabled )
        {
            const rerankerModelContainer = document.getElementById( 'reranker_model_container' );

            // 确保enabled是布尔值
            if ( typeof enabled === 'string' )
            {
                enabled = enabled.toLowerCase() === 'true';
            }
            enabled = Boolean( enabled );

            console.log( "切换重排序模型部分显示状态:", enabled, typeof enabled );

            if ( enabled )
            {
                rerankerModelContainer.style.display = 'block';
            } else
            {
                rerankerModelContainer.style.display = 'none';
            }

            // 同步重排序开关状态
            const isRerankCheckbox = document.getElementById( 'RAG_IS_RERANK' );
            if ( isRerankCheckbox && isRerankCheckbox.checked !== enabled )
            {
                console.log( `同步重排序开关从${ isRerankCheckbox.checked }到${ enabled }` );
                isRerankCheckbox.checked = enabled;

                // 触发change事件，确保其他依赖于这个值的逻辑被更新
                const event = new Event( 'change', { bubbles: true } );
                isRerankCheckbox.dispatchEvent( event );
            }
        }

        // 提交配置表单
        document.getElementById( 'configForm' ).addEventListener( 'submit', function ( event )
        {
            event.preventDefault();

            // 表单验证
            if ( !validateForm() )
            {
                // 如果验证失败，不执行提交
                return;
            }

            // 保存前确保所有选择框的值正确同步到隐藏字段
            const currentEmbeddingModel = document.getElementById( 'RAG_EMBEDDING_MODEL' ).value;
            const embeddingSelect = document.getElementById( 'rag_embedding_model_select' );

            if ( embeddingSelect && embeddingSelect.value === 'custom' )
            {
                const customModel = document.getElementById( 'rag_custom_embedding' ).value;
                if ( customModel )
                {
                    document.getElementById( 'RAG_EMBEDDING_MODEL' ).value = customModel;
                }
            } else if ( embeddingSelect && embeddingSelect.value !== 'custom' )
            {
                document.getElementById( 'RAG_EMBEDDING_MODEL' ).value = embeddingSelect.value;
            }

            // 重排序模型同步
            const rerankerSelect = document.getElementById( 'rag_reranker_model_select' );
            if ( rerankerSelect && rerankerSelect.value === 'custom' )
            {
                const customReranker = document.getElementById( 'rag_custom_reranker' ).value;
                if ( customReranker )
                {
                    document.getElementById( 'RAG_RERANKER_MODEL' ).value = customReranker;
                }
            } else if ( rerankerSelect && rerankerSelect.value !== 'custom' )
            {
                document.getElementById( 'RAG_RERANKER_MODEL' ).value = rerankerSelect.value;
            }

            // 获取表单数据并发送
            const formData = new FormData( this );

            // 添加页面加载和动画效果
            document.getElementById( 'saveButton' ).disabled = true;
            document.getElementById( 'saveButton' ).innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 保存中...';

            fetch( '/save', {
                method: 'POST',
                body: formData
            } )
                .then( response => response.json() )
                .then( data =>
                {
                    document.getElementById( 'saveButton' ).disabled = false;
                    document.getElementById( 'saveButton' ).innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>保存配置';

                    if ( data.status === 'success' )
                    {
                        showNotification( '成功', '配置已成功保存', 'success' );

                        // 在成功保存后重新加载配置
                        setTimeout( () =>
                        {
                            loadCurrentConfig();
                        }, 500 );
                    } else
                    {
                        showNotification( '错误', data.message || '保存配置失败', 'danger' );
                    }
                } )
                .catch( error =>
                {
                    document.getElementById( 'saveButton' ).disabled = false;
                    document.getElementById( 'saveButton' ).innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>保存配置';
                    showNotification( '错误', '保存配置失败: ' + error, 'danger' );
                } );
        } );

        // 加载当前配置
        function loadCurrentConfig ()
        {
            // 首先尝试从localStorage读取RAG配置
            let localRagConfig = null;
            try
            {
                const savedConfig = localStorage.getItem( 'ragConfig' );
                if ( savedConfig )
                {
                    localRagConfig = JSON.parse( savedConfig );
                    console.log( "从localStorage读取到RAG配置:", localRagConfig );
                }
            } catch ( e )
            {
                console.error( "读取localStorage中RAG配置失败:", e );
            }

            fetch( '/get_config' )
                .then( response => response.json() )
                .then( data =>
                {
                    if ( data.status === 'success' )
                    {
                        console.log( "获取到的配置数据:", data.config );

                        // 更新所有表单字段
                        updateFormFields( data.config );

                        // 特别处理自动消息配置
                        const autoMessageInput = document.getElementById( 'AUTO_MESSAGE' );
                        if ( autoMessageInput && data.config.AUTO_MESSAGE )
                        {
                            autoMessageInput.value = data.config.AUTO_MESSAGE.value || "请你模拟系统设置的角色，在微信上找对方聊天";
                        }

                        // 如果localStorage中有RAG配置，应用它
                        if ( localRagConfig )
                        {
                            // 特别处理重排序开关
                            if ( typeof localRagConfig.isRerank !== 'undefined' )
                            {
                                const rerankCheckbox = document.getElementById( 'RAG_IS_RERANK' );
                                if ( rerankCheckbox )
                                {
                                    console.log( `应用localStorage中的重排序状态: ${ localRagConfig.isRerank }` );
                                    rerankCheckbox.checked = Boolean( localRagConfig.isRerank );
                                    // 更新UI显示
                                    toggleRerankModelSection( rerankCheckbox.checked );
                                }
                            }
                        }

                        // 初始化特殊组件
                        initRagSettings();

                        // 确保在配置加载后，选择框和隐藏字段的值保持一致
                        setTimeout( () =>
                        {
                            // 处理重排序开关
                            const isRerankCheckbox = document.getElementById( 'RAG_IS_RERANK' );
                            if ( isRerankCheckbox )
                            {
                                // 从config和localStorage中确定重排序状态的优先级
                                let rerankState = isRerankCheckbox.checked; // 当前UI状态

                                // 优先使用localStorage中的值
                                if ( localRagConfig && typeof localRagConfig.isRerank !== 'undefined' )
                                {
                                    rerankState = Boolean( localRagConfig.isRerank );
                                }
                                // 其次使用从服务器加载的配置
                                else if ( data.config && data.config[ 'RAG_IS_RERANK' ] !== undefined )
                                {
                                    let configValue = data.config[ 'RAG_IS_RERANK' ];
                                    if ( typeof configValue === 'string' )
                                    {
                                        configValue = configValue.toLowerCase() === 'true';
                                    }
                                    rerankState = Boolean( configValue );
                                }

                                console.log( `配置加载后确定重排序状态: ${ rerankState }` );
                                isRerankCheckbox.checked = rerankState;
                                // 确保UI状态正确
                                toggleRerankModelSection( rerankState );
                            }

                            // 确保布尔值配置正确初始化
                            ensureBooleanConfig( 'RAG_IS_RERANK' );
                            ensureBooleanConfig( 'LOCAL_MODEL_ENABLED' );
                            ensureBooleanConfig( 'AUTO_ADAPT_SILICONFLOW' );
                        }, 500 );
                    }
                } )
                .catch( error =>
                {
                    console.error( '获取配置失败:', error );
                } );
        }

        // 修改获取完整API URL的辅助函数，根据模型类型自动添加路径后缀
        function getFullApiUrl ( baseUrl, modelType )
        {
            if ( !baseUrl ) return '';

            // 移除尾部斜杠(如果有)
            let url = baseUrl.trim();
            if ( url.endsWith( '/' ) )
            {
                url = url.slice( 0, -1 );
            }

            // 根据模型类型添加不同的后缀
            if ( modelType === 'rerank' )
            {
                return `${ url }/rerank`;
            } else
            { // 默认为embedding类型
                return `${ url }/embeddings`;
            }
        }

        // 在实际使用API URL的地方，调用getFullApiUrl函数获取完整URL
        // 例如在保存配置或发送API请求时使用:
        // const embeddingApiUrl = getFullApiUrl(document.getElementById('RAG_BASE_URL').value, 'embedding');
        // const rerankApiUrl = getFullApiUrl(document.getElementById('RAG_BASE_URL').value, 'rerank');

        // 添加新函数：更新API URLs
        function updateApiUrls ( baseUrl )
        {
            if ( !baseUrl ) return;

            // 确保baseUrl是字符串格式
            let cleanBaseUrl = getApiUrlValue( baseUrl );
            if ( !cleanBaseUrl ) return;

            // 移除尾部斜杠(如果有)
            if ( cleanBaseUrl.endsWith( '/' ) )
            {
                cleanBaseUrl = cleanBaseUrl.slice( 0, -1 );
            }

            // 更新嵌入API URL
            const embeddingUrl = getFullApiUrl( cleanBaseUrl, 'embedding' );
            document.getElementById( 'RAG_EMBEDDING_URL' ).value = embeddingUrl;

            // 更新重排序API URL
            const rerankUrl = getFullApiUrl( cleanBaseUrl, 'rerank' );
            document.getElementById( 'RAG_RERANK_URL' ).value = rerankUrl;

            // 更新基础URL（确保没有尾部斜杠）
            document.getElementById( 'RAG_BASE_URL' ).value = cleanBaseUrl;

            console.log( "更新API URLs - 基础URL:", cleanBaseUrl, "嵌入URL:", embeddingUrl, "重排序URL:", rerankUrl );
        }

        // 添加处理嵌入和重排序URL的函数，专门解决API URL可能是对象的问题
        function getApiUrlValue ( urlValue )
        {
            // 检查是否是字符串
            if ( typeof urlValue === 'string' )
            {
                let url = urlValue.trim();
                // 移除尾部斜杠
                if ( url.endsWith( '/' ) )
                {
                    url = url.slice( 0, -1 );
                }
                return url;
            }

            // 检查是否是对象（后端可能返回{value: url, type: 'string', description: '...'}格式）
            if ( urlValue && typeof urlValue === 'object' && urlValue.value )
            {
                let url = urlValue.value.trim();
                // 移除尾部斜杠
                if ( url.endsWith( '/' ) )
                {
                    url = url.slice( 0, -1 );
                }
                return url;
            }

            // 默认返回空字符串
            return '';
        }

        // 处理布尔值配置项
        function ensureBooleanConfig ( elementId )
        {
            const element = document.getElementById( elementId );
            if ( element && element.type === 'checkbox' )
            {
                console.log( `${ elementId }配置值(修正前): ${ element.checked }` );
                // 触发状态变更事件，确保UI状态与值一致
                if ( elementId === 'RAG_IS_RERANK' )
                {
                    toggleRerankModelSection( element.checked );
                } else if ( elementId === 'LOCAL_MODEL_ENABLED' )
                {
                    toggleLocalModelSection( element.checked );
                }
                console.log( `${ elementId }配置值(修正后): ${ element.checked }` );
            }
        }

        // 在页面加载时初始化
        document.addEventListener( 'DOMContentLoaded', function ()
        {
            // 添加到initRagSettings函数结束前
            // 立即初始化RAG设置
            try
            {
                // 检查是否有重排序开关元素
                const rerankSwitch = document.getElementById( 'RAG_IS_RERANK' );
                if ( rerankSwitch )
                {
                    // 获取当前开关状态并强制更新UI
                    const isEnabled = rerankSwitch.checked;
                    console.log( `DOMContentLoaded: 初始重排序开关状态=${ isEnabled }` );
                    toggleRerankModelSection( isEnabled );
                }

                // 初始化历史配置列表
                updateHistoryConfigList();
                console.log( '历史配置列表已初始化' );

                // 添加刷新按钮到监听用户列表
                setTimeout( function ()
                {
                    try
                    {
                        addRefreshButtonToListenList();
                    } catch ( e )
                    {
                        console.error( '添加刷新按钮失败:', e );
                    }
                }, 1000 );
            } catch ( e )
            {
                console.error( "初始化配置组件时出错:", e );
            }

            // 确保布尔值配置正确初始化 (第一次)
            setTimeout( function ()
            {
                console.log( "第一次配置状态检查" );
                ensureBooleanConfig( 'RAG_IS_RERANK' );
                ensureBooleanConfig( 'LOCAL_MODEL_ENABLED' );
                ensureBooleanConfig( 'AUTO_ADAPT_SILICONFLOW' );
            }, 500 );

            // 再次确认状态，防止初始加载或Ajax请求后状态不一致
            setTimeout( function ()
            {
                console.log( "第二次配置状态确认" );
                ensureBooleanConfig( 'RAG_IS_RERANK' );
                ensureBooleanConfig( 'LOCAL_MODEL_ENABLED' );
                ensureBooleanConfig( 'AUTO_ADAPT_SILICONFLOW' );

                // 强制UI显示与checkbox状态一致
                const rerankSwitch = document.getElementById( 'RAG_IS_RERANK' );
                if ( rerankSwitch )
                {
                    toggleRerankModelSection( rerankSwitch.checked );
                    console.log( `页面加载后二次确认重排序开关状态: ${ rerankSwitch.checked }` );
                }
            }, 1500 );
        } );

        // 在页面完全加载后再次检查重排序开关状态
        window.onload = function ()
        {
            console.log( "页面完全加载，最终检查重排序开关状态..." );

            // 给一点延迟，确保所有其他初始化完成
            setTimeout( function ()
            {
                // 检查localStorage中是否有保存的值
                try
                {
                    const savedConfig = localStorage.getItem( 'ragConfig' );
                    if ( savedConfig )
                    {
                        const parsedConfig = JSON.parse( savedConfig );
                        if ( parsedConfig && typeof parsedConfig.isRerank !== 'undefined' )
                        {
                            const rerankState = Boolean( parsedConfig.isRerank );
                            console.log( `页面完全加载后，从localStorage读取到重排序状态: ${ rerankState }` );

                            // 获取当前开关状态
                            const rerankCheckbox = document.getElementById( 'RAG_IS_RERANK' );
                            if ( rerankCheckbox )
                            {
                                console.log( `当前开关状态: ${ rerankCheckbox.checked }, 应为: ${ rerankState }` );

                                // 如果不一致，则更新
                                if ( rerankCheckbox.checked !== rerankState )
                                {
                                    rerankCheckbox.checked = rerankState;
                                    // 更新UI显示
                                    toggleRerankModelSection( rerankState );
                                    console.log( `已修正重排序开关状态为: ${ rerankState }` );
                                }
                            }
                        }
                    }
                } catch ( e )
                {
                    console.error( "页面加载完成后检查localStorage配置失败:", e );
                }
            }, 1000 );

            // 添加自动刷新配置数据的功能
            function refreshConfigData ()
            {
                // 获取最新配置数据，特别是监听用户列表
                fetch( '/get_config' )
                    .then( response => response.json() )
                    .then( data =>
                    {
                        if ( data.status === 'success' && data.config )
                        {
                            // 特别更新监听用户列表
                            if ( data.config.LISTEN_LIST )
                            {
                                console.log( "自动刷新: 更新监听用户列表", data.config.LISTEN_LIST );
                                updateListenUserList( data.config.LISTEN_LIST );
                            }
                        }
                    } )
                    .catch( error =>
                    {
                        console.error( "自动刷新配置数据失败:", error );
                    } );
            }

            // 页面加载后立即刷新一次
            refreshConfigData();

            // 然后每15秒自动刷新一次
            setInterval( refreshConfigData, 15000 );
        };

        // 特殊处理重排序开关 - 在初始值设置完成后恢复localStorage中的值
        document.getElementById( 'RAG_IS_RERANK' ).addEventListener( 'change', function ( e )
        {
            // 只处理用户手动更改的事件，忽略程序触发的
            if ( this.dataset.init === 'true' )
            {
                console.log( `用户手动更改重排序开关到: ${ this.checked }` );

                // 立即保存到localStorage
                try
                {
                    const savedConfig = localStorage.getItem( 'ragConfig' );
                    let globalConfig = savedConfig ? JSON.parse( savedConfig ) : {};
                    globalConfig.isRerank = this.checked;
                    globalConfig.savedTime = new Date().getTime();
                    localStorage.setItem( 'ragConfig', JSON.stringify( globalConfig ) );
                    console.log( `已更新localStorage中的重排序状态为: ${ this.checked }` );
                } catch ( e )
                {
                    console.error( "更新localStorage中RAG配置失败:", e );
                }
            } else
            {
                console.log( `程序设置重排序开关到: ${ this.checked }` );
                this.dataset.init = 'true';
            }
        } );

        // 添加刷新监听用户列表的函数
        function refreshListenUserList ()
        {
            // 显示刷新提示
            showSaveNotification( '正在刷新监听用户列表...', 'info' );

            // 获取最新配置数据
            fetch( '/get_config' )
                .then( response => response.json() )
                .then( data =>
                {
                    if ( data.status === 'success' && data.config )
                    {
                        if ( data.config.LISTEN_LIST )
                        {
                            console.log( "手动刷新监听用户列表:", data.config.LISTEN_LIST );
                            updateListenUserList( data.config.LISTEN_LIST );
                            showSaveNotification( '监听用户列表已更新', 'success' );
                        } else
                        {
                            showSaveNotification( '没有监听用户数据', 'warning' );
                        }
                    } else
                    {
                        showSaveNotification( '刷新监听用户列表失败: ' + ( data.message || '未知错误' ), 'error' );
                    }
                } )
                .catch( error =>
                {
                    console.error( "刷新监听用户列表失败:", error );
                    showSaveNotification( '刷新监听用户列表失败: ' + error, 'error' );
                } );
        }

        // 添加用户函数
        function addUser ( key )
        {
            const inputElement = document.getElementById( 'new_user_' + key );
            const newValue = inputElement.value.trim();

            if ( newValue )
            {
                const targetElement = document.getElementById( key );
                const currentValues = targetElement.value ? targetElement.value.split( ',' ) : [];
                if ( !currentValues.includes( newValue ) )
                {
                    currentValues.push( newValue );
                    targetElement.value = currentValues.join( ',' );

                    // 添加到用户列表显示
                    const userListElement = document.getElementById( 'selected_users_' + key );
                    const userDiv = document.createElement( 'div' );
                    userDiv.className = 'list-group-item d-flex justify-content-between align-items-center';
                    userDiv.innerHTML = `
                        ${ newValue }
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeUser('${ key }', '${ newValue }')">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    `;
                    userListElement.appendChild( userDiv );

                    // 清空输入框
                    inputElement.value = '';
                }
            }
            updateTaskChatIdOptions();
        }

        // 定义一个查找LISTEN_LIST元素并添加刷新按钮的函数
        function addRefreshButtonToListenList ()
        {
            // 查找监听用户列表的控制区域
            const listenListInputGroup = document.querySelector( 'input#new_user_LISTEN_LIST' ).parentElement;

            // 如果已经存在刷新按钮，则不再添加
            if ( listenListInputGroup.querySelector( '.refresh-button' ) )
            {
                return;
            }

            // 创建刷新按钮
            const refreshButton = document.createElement( 'button' );
            refreshButton.type = 'button';
            refreshButton.className = 'btn btn-secondary ms-2 refresh-button';
            refreshButton.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 刷新';
            refreshButton.onclick = refreshListenUserList;

            // 添加到控制区域
            listenListInputGroup.appendChild( refreshButton );

            console.log( '添加监听用户列表刷新按钮' );
        }

        // 在页面加载完成后添加刷新按钮
        document.addEventListener( 'DOMContentLoaded', function ()
        {
            // 其他初始化代码...

            // 当页面元素完全加载后添加刷新按钮
            setTimeout( function ()
            {
                try
                {
                    addRefreshButtonToListenList();
                } catch ( e )
                {
                    console.error( '添加刷新按钮失败:', e );
                }
            }, 1000 );
        } );
    </script>
</body>

</html>